<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>微卡首页</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/buttons.css">
    <link rel="stylesheet" href="../css/homepage.css">
    <link rel="stylesheet" href="../css/loading.css">
    <link rel="stylesheet" href="../css/form-control-v2-7.css">
    <!-- Quill stylesheet -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/default.min.css" title="Default" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/a11y-dark.min.css" title="A 11 Y Dark" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/agate.min.css" title="Agate" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/an-old-hope.min.css" title="An Old Hope" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/androidstudio.min.css" title="Android Studio" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/atom-one-dark-reasonable.min.css" title="Atom One Dark Reasonable" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/atom-one-dark.min.css" title="Atom One Dark" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/ir-black.min.css" title="Ir Black" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/monokai-sublime.min.css" title="Monokai Sublime" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/monokai.min.css" title="Monokai" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/obsidian.min.css" title="Obsidian" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/railscasts.min.css" title="Railscasts" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/sunburst.min.css" title="Sunburst" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/tomorrow-night-bright.min.css" title="Tomorrow Night Bright" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/tomorrow-night-eighties.min.css" title="Tomorrow Night Eighties" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/tomorrow-night.min.css" title="Tomorrow Night" disabled>
    <link rel="alternate stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/vs2015.min.css" title="VS 2015" disabled>

    <script src="../js/vendor/jquery.min.js"></script>
    <script src="../js/vendor/angular.min.js"></script>
    <script src="../js/vendor/popper.min.js"></script>
    <script src="../js/vendor/bootstrap.min.js"></script>
    <script src="../js/vendor/underscore.min.js"></script>
    <script src="../js/vendor/loading.js"></script>
    <script src="../js/vendor/inspect_image.js"></script>
    <script src="../js/vendor/alert.js"></script>
    <script src="../js/_web_config.js"></script>
    <script src="../js/_index_controller.js"></script>
    <script src="../js/_index_refresh.js"></script>

    <script src="../js/_index_create_card.js"></script>
    <script src="../js/_index_create_card_with_images.js"></script>
    <script src="../js/_index_create_card_with_quill.js"></script>
    <script src="../js/_index_like_card.js"></script>
    <script src="../js/_index_like_card_cancel.js"></script>
    <script src="../js/_index_share_card.js"></script>

    <script src="../js/_index_submit_card_comment.js"></script>
    <script src="../js/_index_reply_card_comment.js"></script>
    <script src="../js/_index_delete_card_comment.js"></script>
    <script src="../js/_index_like_comment.js"></script>
    <script src="../js/_index_like_comment_cancel.js"></script>

    <script src="../js/_index_delete_card.js"></script>
</head>

<body onload="refresh();" onbeforeunload="logout()">
    <!-- module index (card) -->
    <div ng-app="module-index" ng-cloak="ng-cloak">
        <div ng-controller="controller">
            <!-- data for cards -->
            <input id="user" style="display:none;" ng-model="user">
            <input id="card-groups" style="display:none;" ng-model="cardGroups">
            <input id="my-card-groups" style="display:none;" ng-model="myCardGroups">
            <input id="current-card" style="display:none;" ng-model="current_card">
            <input id="cards-view-mode" style="display:none;" ng-model="cardsViewMode">

            <!-- data for chat -->
            <input id="user-data" style="display:none;" ng-model="userData">
            <input id="data-groups" style="display:none;" ng-model="userData.groups">
            <input id="chat-message-list" style="display:none;" ng-model="chatMessageList">


            <div class="fake-navbar w-100 alert-secondary">
                <!-- fake navbar -->
                <nav class="navbar navbar-expand-lg navbar-dark alert-secondary px-2"
                     ng-class="isNavbarMinimized === true ? 'py-0' : 'py-2'"
                     style="opacity: 0.3;">
                    <a class="navbar-brand" href="#">fake navbar</a>
                </nav>
                <!-- fake portal bar -->
                <div class="w-100 p-2 alert-secondary" ng-if="currentChatItemId !== 'external'"
                     style="opacity: 0.3;">
                    <div class="text-center">
                        <div class="text-white">fake portal bar</div>
                    </div>
                </div>
                <!-- search cards results -->
                <div class="search-results" ng-show="isSearching === true">
                    <div class="search-results-container">
                        <div class="search-results-wrapper">
                            <!-- stop search cards -->
                            <div class="stop-search-button-wrapper">
                                <i class="fa fa-lg fa-times-circle mb-1 text-muted" ng-click="stopSearch()"></i>
                            </div>
                            <ul class="list-group" ng-if="isSearchingLoading">
                                <!-- search card: loading -->
                                <li class="list-group-item list-group-item-secondary text-center">
                                    <span class="fa fa-spinner fa-pulse fa-fw"></span>
                                    搜索中 ...
                                </li>
                            </ul>
                            <ul class="list-group" ng-if="!isSearchingLoading">
                                <li class="list-group-item" ng-repeat="card in searchResults track by $index">
                                    <div class="row" ng-click="viewCard(card)">
                                        <div class="col col-12 col-lg-8">
                                            <h5 class="w-100 cursor-pointer overflow-hidden">
                                                <small class="d-flex align-items-center justify-content-start">
                                                    <span class="d-inline-block">
                                                        <img ng-src="{{card.user.avatarUrl}}" alt="" class="user-avatar-xxs rounded-circle">
                                                    </span>
                                                    <small class="d-inline-block ml-1 pt-1 text-muted overflow-hidden" style="min-width: 40px;width: 40px;max-width: 40px;">
                                                        {{card.user.nickname}}
                                                    </small>
                                                    <span class="ml-2" ng-if="card.type !== 'share'">
                                                        <span ng-if="keyword">
<!--                                                        code line below can not be formatted into several lines for preventing white spaces -->
                                                            <span ng-repeat="slice in card.title.split(keyword) track by $index"><span ng-bind="slice"></span><span ng-if="!$last" ng-bind="keyword" class="highlight"></span></span>
                                                        </span>
                                                        <!-- when searching topic -->
                                                        <span ng-if="!keyword">
                                                            {{card.title}}
                                                        </span>
                                                    </span>
                                                    <span class="ml-2 text-muted" ng-if="card.type === 'share'">
                                                        <i class="fa fa-share"></i>
                                                            转发卡片
                                                    </span>
                                                </small>
                                            </h5>
                                            <div class="w-100 d-flex align-items-center justify-content-start">
                                                <small>
                                                    <span ng-if="keyword">
<!--                                                    code line below can not be formatted into several lines for preventing white spaces -->
                                                        <span ng-repeat="slice in card.text.split(keyword) track by $index">{{slice|textLengthSet:true:110:'...'}}<span ng-if="!$last" ng-bind="keyword" class="highlight"></span></span>
                                                    </span>
                                                    <!-- when searching topic -->
                                                    <span ng-if="!keyword">
                                                        {{card.text|textLengthSet:true:110:'...'}}
                                                    </span>
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col col-12 mt-2 col-lg-4 px-lg-3 mt-lg-0 d-flex align-items-center justify-content-center">
                                            <div class="w-100 overflow-hidden bg-dark" style="max-height:88px;">
                                                <img src="{{card.images[0].url}}" alt="image not found" class="d-block mx-auto" ng-if="card.type === 'image' && card.images.length"
                                                     style="height:88px;">
                                                <video src="{{card.video.url}}" controls="controls" class="d-block mx-auto" ng-if="card.type === 'video'" style="height:88px;">
                                                    你的浏览器不支持视频播放
                                                </video>
                                                <div class="d-block mx-auto bg-white" ng-if="['text','share'].includes(card.type)">
                                                    <div style="line-height: 1rem;">
                                                        <div class="row">
                                                            <div class="col">
                                                                <small>热度:</small>
                                                            </div>
                                                            <div class="col">
                                                                <small>{{card.cardHot}}</small>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col">
                                                                <small>转发:</small>
                                                            </div>
                                                            <div class="col">
                                                                <small>{{card.shareNum}}</small>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col">
                                                                <small>评论:</small>
                                                            </div>
                                                            <div class="col">
                                                                <small>{{card.commentNum}}</small>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col">
                                                                <small>发布时间:</small>
                                                            </div>
                                                            <div class="col">
                                                                <small>{{card.createdTime}}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>

                                <!-- search card: no search result -->
                                <li class="list-group-item list-group-item-danger text-center" ng-if="!searchResults || !(searchResults.length)">
                                    无搜索结果, 换一个关键词试试
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>



            <div class="fixed-top navbar-wrapper">
                <!-- desktop client navbar -->
                <div class="navbar-inner-wrapper desktop-client-navbar">
                    <!-- navbar -->
                    <ul class="nav navbar navbar-expand-lg px-2 {{isNavbarBackgroundDark ? 'navbar-dark bg-dark' : 'navbar-light alert-secondary'}}" 
                        ng-class="isNavbarMinimized === true ? 'py-0' : 'py-2'">
                        <!-- 左侧 -->
                        <!-- 如果用户登入了，就显示用户头像 -->
                        <a class="navbar-brand py-0 ml-1 ml-lg-2 mr-2 mr-lg-3" ng-click="gotoPage('settings');" href="#" ng-show="user">
                            <img class="user-avatar rounded-circle border" ng-src="{{user.avatarUrl}}" alt="x">
                        </a>
                        <!-- 如果用户没登录，就显示商标 -->
                        <a class="navbar-brand py-0 d-flex align-items-center text-color-animated ml-1 ml-lg-2" href="javascript:login('../index.html');" ng-show="!user">
                            <span>微卡</span>
                        </a>
                        <li class="nav-item" ng-click="gotoPage('marketplace');">
                            <a class="nav-link" ng-class="pageLocation==='marketplace'?'text-white bg-secondary':isNavbarBackgroundDark?'text-white':'text-dark'" href="#marketplace">
                                <span>广场</span>
                            </a>
                        </li>

                        <!-- 如果用户登录了 -->
                        <li class="nav-item" ng-click="gotoPage('mySocialCircle');" ng-show="user">
                            <a class="nav-link" ng-class="pageLocation==='mySocialCircle'?'text-white bg-secondary':isNavbarBackgroundDark?'text-white':'text-dark'" href="#mySocialCircle">
                                <span>关注</span>
                            </a>
                        </li>
                        <!-- 如果用户未登录 -->
                        <li class="nav-item" ng-show="!user">
                            <a class="nav-link" ng-class="isNavbarBackgroundDark?'text-white':'text-dark'" 
                               href="javascript:login('../index.html',{'page': 'my-social-circle'});">
                                <span class="text-muted">关注</span>
                            </a>
                        </li>

                        <!-- 如果用户登录了 -->
                        <li class="nav-item" ng-click="gotoPage('cards');" ng-show="user">
                            <a class="nav-link" ng-class="pageLocation==='cards'?'text-white bg-secondary':isNavbarBackgroundDark?'text-white':'text-dark'" 
                               href="#cards">
                                <span>我的卡片</span>
                            </a>
                        </li>
                        <!-- 如果用户未登录 -->
                        <li class="nav-item" ng-show="!user">
                            <a class="nav-link" ng-class="isNavbarBackgroundDark?'text-white':'text-dark'" 
                               href="javascript:login('../index.html',{'page': 'my-cards'});">
                                <span class="text-muted">我的卡片</span>
                            </a>
                        </li>

                        <!-- 如果用户登录了 -->
                        <li class="nav-item" ng-click="gotoPage('homepage');" ng-show="user">
                            <a class="nav-link"
                               ng-class="(['homepage','chat','trans-home-chat','trans-chat-home'].includes(pageLocation)?'text-white bg-secondary':isNavbarBackgroundDark?'text-white':'text-dark')"
                               href="#">
                                <span>聊天</span>
                                <span class="badge badge-info upper" ng-if="total_unread_message_count">
                                    <span ng-bind="total_unread_message_count"></span>
                                </span>
                            </a>
                        </li>
                        <!-- 如果用户未登录 -->
                        <li class="nav-item" ng-show="!user">
                            <a class="nav-link" ng-class="isNavbarBackgroundDark?'text-white':'text-dark'" 
                               href="javascript:login('../index.html',{'page': 'homepage'})">
                                <span class="text-muted">聊天</span>
                            </a>
                        </li>

                        <!-- 如果用户登录了, 则显示设置(个人中心) tab -->
                        <!-- 如果用户未登录, 也显示设置(个人中心) tab -->
                        <li class="nav-item" ng-click="gotoPage('settings');">
                            <a class="nav-link" ng-class="pageLocation==='settings'?'text-white bg-secondary':isNavbarBackgroundDark?'text-white':'text-dark'" href="#">
                                <span>设置</span>
                            </a>
                        </li>

                        <!-- 右侧 -->
                        <li class="nav-item px-3 d-flex justify-content-center align-items-center ml-auto" ng-show="user"
                            data-style="no-support">
                            <a class="nav-link py-0" href="#">
                                <div class="btn btn-sm btn-outline-danger" onclick="logout('../index.html')">
                                    <span>登出</span>
                                    <i class="fa fa-sign-out"></i>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item d-flex justify-content-center align-items-center ml-auto" ng-show="!user"
                            data-style="no-support">
                            <a class="nav-link py-0 pr-0" href="javascript:login('../index.html');">
                                <div class="btn btn-sm btn-outline-primary">
                                    <span>登录</span>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item pr-3 d-flex justify-content-center align-items-center" ng-show="!user"
                            data-style="no-support">
                            <a class="nav-link py-0 pr-0" href="../signup.html?target=../index.html">
                                <div class="btn btn-sm btn-outline-primary">
                                    <span>注册</span>
                                </div>
                            </a>
                        </li>
                        <!-- 刷新页面 -->
                        <li class="nav-item pr-3 d-flex justify-content-center align-items-center"
                            data-style="no-support">
                            <button class="button button-small button-border button-circle"
                                    ng-click="refreshCurrentPage();isLoggedIn();"
                                    ng-class="isNavbarBackgroundDark ? 'button-plain' : 'button-inverse'">
                                <i class="fa fa-refresh"></i>
                            </button>
                        </li>
                        <!-- 搜索卡片 -->
                        <li class="nav-item px-3 d-flex justify-content-center align-items-center"
                            data-style="no-support">
                            <input class="form-control form-control-sm mr-sm-2" placeholder="Search" type="search" ng-model="keyword" ng-change="scheduledSearch()" style="min-width: 165px;">
                        </li>
                    </ul>
                </div>

                <!-- mobile client navbar -->
                <div class="navbar-inner-wrapper mobile-client-navbar">
                    <!-- navbar -->
                    <ul class="nav navbar navbar-expand-lg px-2 {{isNavbarBackgroundDark ? 'navbar-dark bg-dark' : 'navbar-light alert-secondary'}}" 
                        ng-class="isNavbarMinimized === true ? 'py-0' : 'py-2'">
                        <!-- 如果用户登入了，就显示用户头像 -->
                        <a class="navbar-brand py-0 ml-1 ml-lg-2 mr-2 mr-lg-3" ng-click="gotoPage('settings');" href="#" ng-show="user">
                            <img class="user-avatar rounded-circle border" ng-src="{{user.avatarUrl}}" alt="x">
                        </a>
                        <!-- 如果用户没登录，就显示商标 -->
                        <a class="navbar-brand py-0 d-flex align-items-center text-color-animated ml-1 ml-lg-2" href="javascript:login('../index.html');" ng-show="!user">
                            微卡
                        </a>
                        <li class="nav-item" style="position: relative;">
                            <div class="nav-link" ng-class="isNavbarBackgroundDark?'text-white':'text-dark'" data-toggle="dropdown">
                                <i class="fa fa-lg fa-align-justify"></i>
                            </div>
                            <div class="dropdown-menu" style="min-width: 200px;">
                                <a class="dropdown-item" href="#marketplace">
                                    <div ng-click="gotoPage('marketplace');">
                                        <i class="fa fa-circle" ng-if="pageLocation === 'marketplace'"></i>
                                        <i class="fa fa-circle-o" ng-if="pageLocation !== 'marketplace'"></i>
                                        <div class="d-inline-block ml-2">广场</div>
                                    </div>
                                </a>
                                <a class="dropdown-item" ng-show="user" href="#mySocialCircle">
                                    <div ng-click="gotoPage('mySocialCircle');">
                                        <i class="fa fa-circle" ng-if="pageLocation === 'mySocialCircle'"></i>
                                        <i class="fa fa-circle-o" ng-if="pageLocation !== 'mySocialCircle'"></i>
                                        <div class="d-inline-block ml-2">关注</div>
                                    </div>
                                </a>
                                <a class="dropdown-item" ng-show="user" href="#cards">
                                    <div ng-click="gotoPage('cards');">
                                        <i class="fa fa-circle" ng-if="pageLocation === 'cards'"></i>
                                        <i class="fa fa-circle-o" ng-if="pageLocation !== 'cards'"></i>
                                        <div class="d-inline-block ml-2">我的卡片</div>
                                    </div>
                                </a>
                                <a class="dropdown-item" ng-show="user" href="#">
                                    <div ng-click="gotoPage('homepage');">
                                        <i class="fa fa-circle" ng-if="pageLocation === 'homepage'"></i>
                                        <i class="fa fa-circle-o" ng-if="pageLocation !== 'homepage'"></i>
                                        <div class="d-inline-block ml-2">聊天</div>
                                    </div>
                                </a>
                                <a class="dropdown-item" ng-show="user" href="#">
                                    <div ng-click="gotoPage('settings');">
                                        <i class="fa fa-circle" ng-if="pageLocation === 'settings'"></i>
                                        <i class="fa fa-circle-o" ng-if="pageLocation !== 'settings'"></i>
                                        <div class="d-inline-block ml-2">设置</div>
                                    </div>
                                </a>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item" ng-show="user">
                                    <div class="btn btn-sm btn-block btn-outline-danger" onclick="logout('../index.html');">
                                        <span>登出</span>
                                        <i class="fa fa-sign-out"></i>
                                    </div>
                                </div>
                                <div class="dropdown-item" ng-show="!user">
                                    <div class="btn btn-sm btn-block btn-outline-primary" onclick="login('../index.html');">
                                        <span>登录</span>
                                    </div>
                                </div>
                                <div class="dropdown-item" ng-show="!user">
                                    <a class="btn btn-sm btn-block btn-outline-primary" href="../signup.html?target=../index.html">
                                        <span>注册</span>
                                    </a>
                                </div>
                            </div>
                        </li>
                        <!-- 搜索卡片 -->
                        <li class="nav-item px-3 ml-auto d-flex justify-content-center align-items-center" data-style="no-support">
                            <input class="form-control form-control-sm mr-sm-2" placeholder="Search" type="search" ng-model="keyword" ng-change="scheduledSearch()" style="min-width: 200px;">
                        </li>
                    </ul>
                </div>
                <!-- portal bar -->
                <div class="w-100 p-2 bg-primary text-white current-portal" ng-if="currentChatItemId !== 'external'">
                    <div class="overflow-hidden">
                        <div class="d-flex justify-content-between">
                            <span class="mr-2 px-1 cursor-pointer" ng-click="goBack()">
                                <i class="fa fa-chevron-left"></i>
                            </span>
                            <span class="px-1 cursor-pointer" data-toggle="tooltip" title="{{currentChatItemId}} '{{currentChatItemType}}'">
                                {{currentChatItemName}}
                            </span>
                            <span class="mr-2 px-1 cursor-pointer" data-toggle="tooltip" title="查看好友个人信息" data-placement="left" ng-if="currentChatItemType === 'friend'"
                                  ng-click="show_current_chat_object_info()">
                                <i class="fa fa-user-o fa-lg"></i>
                            </span>
                            <span class="mr-2 px-1 cursor-pointer" data-toggle="tooltip" title="查看聊天室信息" data-placement="left" ng-if="currentChatItemType === 'room'"
                                  ng-click="show_current_chat_object_info()">
                                <i class="fa fa-home fa-lg"></i>
                            </span>
                            <span class="mr-2 px-1 cursor-pointer" ng-if="!['room','friend'].includes(currentChatItemType)">
                                <i class="fa fa-info-circle fa-lg"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>


            <!-- /* z-index of it should be no more than 1050 */ -->
            <div class="d-inline-block px-3 py-2 border bg-white"
                 style="position:fixed;bottom: 0;right: 0;z-index: 1049;"
                 ng-show="user && (['marketplace','mySocialCircle'].includes(pageLocation) || pageLocation === 'cards' && subPageLocation !== 'write')"
                 ng-click="gotoPage('cards');subPageLocation = 'write';">
                <span class="fa fa-3x fa-pencil" title="撰写卡片" data-toggle="tooltip"></span>
            </div>


            <!-- marketplace and mySocialCircle -->
            <div class="cards container-fluid mt-3" ng-show="['marketplace','mySocialCircle'].includes(pageLocation)">
                <div class="row">
                    <!-- 二级导航栏 -->
                    <div class="col-12 col-sm-12 col-md-12 offset-lg-2 col-lg-8">
                        <div class="row mb-3">
                            <div class="col-12 col-md-10 col-lg-8 mx-auto">

                                <div class="row" ng-show="pageLocation === 'marketplace'">
                                    <div class="col-4 px-0">
                                        <button class="btn btn-sm btn-block btn-outline-primary border-radius-0 overflow-hidden {{subPageLocation==='popular'?'active':''}}"
                                                ng-click="subPageLocation = 'popular';refresh();">
                                            热门卡片
                                        </button>
                                    </div>
                                    <div class="col-4 px-0">
                                        <button class="btn btn-sm btn-block btn-outline-primary border-radius-0 border-left-0 overflow-hidden {{subPageLocation==='newest'?'active':''}}"
                                                ng-click="subPageLocation = 'newest';refresh();">
                                            最新卡片
                                        </button>
                                    </div>
                                    <div class="col-4 px-0">
                                        <button class="btn btn-sm btn-block btn-outline-primary border-radius-0 border-left-0 overflow-hidden" ng-click="launchSearchTopicModal()">
                                            查找话题
                                        </button>
                                    </div>
                                </div>

                                <div class="row" ng-show="pageLocation === 'mySocialCircle'">
                                    <div class="col-4 px-0">
                                        <button class="btn btn-sm btn-block btn-outline-primary border-radius-0 overflow-hidden {{subPageLocation==='myFollowingCards'?'active':''}}"
                                                ng-click="subPageLocation = 'myFollowingCards';refreshFollowingCards();">
                                            关注的人的卡片
                                        </button>
                                    </div>
                                    <div class="col-4 px-0">
                                        <button class="btn btn-sm btn-block btn-outline-primary border-radius-0 border-left-0 overflow-hidden {{subPageLocation==='myFollowingUsers'?'active':''}}"
                                                ng-click="subPageLocation = 'myFollowingUsers';loadUserFollowing(user);">
                                            我关注的人
                                        </button>
                                    </div>
                                    <div class="col-4 px-0">
                                        <button class="btn btn-sm btn-block btn-outline-primary border-radius-0 border-left-0 overflow-hidden {{subPageLocation==='myFollowers'?'active':''}}"
                                                ng-click="subPageLocation = 'myFollowers';loadUserFans(user);">
                                            我的粉丝
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>




                <div class="row">
                    <!-- 所有人的所有卡片 -->
                    <div class="col-12 col-sm-12 col-md-12 col-lg-12" ng-show="['popular','newest','myFollowingCards'].includes(subPageLocation)">
                        <div ng-if="['classic'].includes(cardsViewMode)">
                            <div class="card-columns" ng-repeat="cards in cardGroups track by $index">
                                <div ng-repeat="card in cards track by $index">
                                    <!-- 如果卡片不是转发卡片 -->
                                    <wc-card-preview 
                                        ng-if="card.type !== 'share'"
                                        card="card"
                                        user="user"></wc-card-preview>
                                    <!-- 如果卡片是转发卡片 -->
                                    <wc-shared-card-preview 
                                        ng-if="card.type === 'share' && card.share"
                                        card="card"
                                        user="user"></wc-shared-card-preview>
                                </div>
                            </div>
                        </div>
                        <div ng-if="['list'].includes(cardsViewMode)">
                            <div ng-repeat="cards in cardGroups track by $index">
                                <ul class="list-group mb-1">
                                    <li class="list-group-item cursor-pointer hover-inner-shadow"
                                        ng-class="{'list-group-item-primary' : card.isLoadedRightNow}"
                                        ng-repeat="card in cards track by $index"
                                        ng-click="viewCard(card)">
                                        <div class="row">
                                            <div class="col-12 col-lg-9" ng-bind="card.title"></div>
                                            <div class="col-12 col-lg-3" ng-bind="card.user.username"></div>
                                        </div>
                                        <div ng-bind="card.text"></div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    
                    
                    <!-- 话题区域 -->
                    <div class="col-12 col-sm-12 col-md-10 offset-md-1 col-lg-6 offset-lg-3" ng-show="['marketplace'].includes(pageLocation) && ['topics'].includes(subPageLocation)">
                        <div class="p3">
                            <div class="form-group">
                                <input type="text" class="form-control" ng-model="topicName" placeholder="话题名称">
                            </div>
                            <div class="btn btn-primary" ng-click="searchTopic(topicName)">搜索话题</div>
                        </div>
                    </div>
                    
                    

                    <!-- 所有人的卡片 -->
                    <!-- 加载更多卡片 -->
                    <div class="col-12 col-sm-12 col-md-12 offset-lg-2 col-lg-8" ng-show="['marketplace'].includes(pageLocation) && ['popular','newest'].includes(subPageLocation)">
                        <div class="text-center my-4">
                            <div class="btn btn-block btn-outline-primary border-radius-0" ng-click="load_more_cards()" ng-if="has_more_cards">
                                <span>加载更多卡片</span>
                            </div>
                            <div ng-if="!has_more_cards">
                                <span class="text-muted">没有更多卡片了</span>
                            </div>
                        </div>
                    </div>
                    

                    <!-- 我关注的人的卡片 -->
                    <!-- 加载更多卡片 -->
                    <div class="col-12 col-sm-12 col-md-12 offset-lg-2 col-lg-8" ng-show="['mySocialCircle'].includes(pageLocation) && ['myFollowingCards'].includes(subPageLocation)">
                        <div class="text-center my-4">
                            <div class="btn btn-block btn-outline-success border-radius-0" ng-click="load_more_following_cards()" ng-if="has_more_following_cards">
                                <span>加载更多卡片</span>
                            </div>
                            <div ng-if="!has_more_following_cards">
                                <span class="text-muted">没有更多卡片了</span>
                            </div>
                        </div>
                    </div>




                    <!-- 我关注的用户 -->
                    <div class="col-12 col-sm-12 col-md-12 col-lg-12" ng-show="subPageLocation === 'myFollowingUsers'">
                        <!-- 没有关注的用户 -->
                        <div class="card border-radius-0 mx-auto" style="width: 30rem;" ng-show="!user.following || !user.following.length">
                            <div class="card-body bg-white text-center px-5" style="opacity: .8;">
                                <button class="btn btn-block btn-outline-danger border-radius-0" disabled>
                                    你没有关注任何人
                                </button>
                            </div>
                        </div>
                        <!-- 有关注的用户，显示我关注的用户 -->
                        <div class="card-columns" ng-show="user.following && user.following.length">
                            <div class="card border-radius-0 hover-shadow transition-all-300ms" style="height: 360px;background-image: url({{person.styleImgUrl}});background-repeat: no-repeat;background-size: cover;"
                                 ng-repeat="person in user.following track by $index">
                                <div class="card-body bg-white text-center" style="opacity: .8;">
                                    <h5 class="card-title d-flex align-items-center justify-content-center">
                                        <span class="d-inline-block text-center">
                                            <img ng-src="{{person.avatarUrl}}" alt="x" class="user-avatar-sm rounded-circle img-thumbnail">
                                        </span>
                                        <span class="ml-2">{{person.nickname}}</span>
                                    </h5>
                                    <p class="card-text mb-2 overflow-hidden">
                                        <span ng-switch="person.gender">
                                            <span ng-switch-when="male">男</span>
                                            <span ng-switch-when="female">女</span>
                                            <span ng-switch-default>未知性别</span>
                                        </span>
                                        <span>{{person.city}}</span>
                                    </p>
                                    <div class="w-100" onselectstart="return false;">
                                        <i class="fa fa-folder-open cursor-pointer" data-toggle="collapse" data-target="#collapse-following-info-{{person.id}}">
                                        </i>
                                    </div>
                                    <div class="collapse" id="collapse-following-info-{{person.id}}">
                                        <p class="card-text mb-2 overflow-hidden">用户名: {{person.username}}</p>
                                        <p class="card-text mb-2 overflow-hidden">个性签名: {{person.signature}}</p>
                                        <p class="card-text mb-2 overflow-hidden">粉丝数: {{person.fansNum}}</p>
                                        <p class="card-text mb-2 overflow-hidden">关注数: {{person.followNum}}</p>
                                        <p class="card-text overflow-hidden">卡片数: {{person.cardsNum}}</p>
                                        <div class="w-100">
                                            <button class="btn btn-danger" ng-click="unfollowUser(person)">
                                                取消关注
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>




                    <!-- 我的粉丝 -->
                    <div class="col-12 col-sm-12 col-md-12 col-lg-12" ng-show="subPageLocation === 'myFollowers'">
                        <!-- 没有粉丝 -->
                        <div class="card border-radius-0 mx-auto" style="width: 30rem;" ng-show="!user.fans || !user.fans.length">
                            <div class="card-body bg-white text-center px-5" style="opacity: .8;">
                                <button class="btn btn-block btn-outline-danger border-radius-0" disabled>
                                    现在还没有粉丝，多发些卡片吧
                                </button>
                            </div>
                        </div>
                        <!-- 有粉丝 -->
                        <div class="card-columns" ng-show="user.fans && user.fans.length">
                            <div class="card border-radius-0 hover-shadow transition-all-300ms" style="height: 360px;background-image: url({{person.styleImgUrl}});background-repeat: no-repeat;background-size: cover;"
                                 ng-repeat="person in user.fans track by $index">
                                <div class="card-body bg-white text-center" style="opacity: .8;">
                                    <h5 class="card-title d-flex align-items-center justify-content-center">
                                        <span class="d-inline-block text-center">
                                            <img ng-src="{{person.avatarUrl}}" alt="x" class="user-avatar-sm rounded-circle img-thumbnail">
                                        </span>
                                        <span class="ml-2">{{person.nickname}}</span>
                                    </h5>
                                    <p class="card-text mb-2 overflow-hidden">
                                        <span ng-switch="person.gender">
                                            <span ng-switch-when="male">男</span>
                                            <span ng-switch-when="female">女</span>
                                            <span ng-switch-default>未知性别</span>
                                        </span>
                                        <span>{{person.city}}</span>
                                    </p>
                                    <div class="w-100" onselectstart="return false;">
                                        <i class="fa fa-folder-open cursor-pointer" data-toggle="collapse" data-target="#collapse-fans-info-{{person.id}}">
                                        </i>
                                    </div>
                                    <div class="collapse" id="collapse-fans-info-{{person.id}}">
                                        <p class="card-text mb-2 overflow-hidden">用户名: {{person.username}}</p>
                                        <p class="card-text mb-2 overflow-hidden">个性签名: {{person.signature}}</p>
                                        <p class="card-text mb-2 overflow-hidden">粉丝数: {{person.fansNum}}</p>
                                        <p class="card-text mb-2 overflow-hidden">关注数: {{person.followNum}}</p>
                                        <p class="card-text overflow-hidden">卡片数: {{person.cardsNum}}</p>
                                        <div class="w-100">
                                            <button class="btn btn-success" ng-show="!isFollowing(person)" ng-click="followUser(person)">
                                                &nbsp;&nbsp;关注&nbsp;&nbsp;
                                            </button>
                                            <button class="btn btn-danger" ng-show="isFollowing(person)" ng-click="unfollowUser(person)">
                                                取消关注
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>





                </div>
            </div>
            <!-- end of page "marketplace" and page "mySocialCircle" -->




            <div class="create-card container-fluid mt-3" ng-show="pageLocation === 'cards'">
                <!-- 用户未登录 -->
                <div class="row" ng-show="!user">
                    <div class="col-12 col-sm-12 col-md-12 offset-lg-2 col-lg-8">
                        <div class="alert alert-warning py-5 mt-4">
                            <div class="display-4 text-center cursor-pointer" onclick="login('../index.html');">
                                <i class="fa fa-exclamation-triangle"></i>
                                请先登录
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 用户登录了 -->
                <div class="row" ng-show="user">
                    <!-- 标签栏 -->
                    <div class="col-12 col-sm-12 col-md-12 offset-lg-2 col-lg-8">
                        <div class="row overflow-hidden" onselectstart="return false;">
                            <div class="col px-0 px-lg-3">
                                <p class="overflow-hidden py-1 text-center cursor-pointer {{subPageLocation==='myCards'?'text-white bg-dark':'font-weight-light'}}"
                                    ng-click="subPageLocation = 'myCards';refreshMyCards();">
                                    我的卡片
                                </p>
                            </div>
                            <div class="col px-0 px-lg-3">
                                <p class="overflow-hidden py-1 text-center cursor-pointer {{subPageLocation==='write'?'text-white bg-dark':'font-weight-light'}}"
                                    ng-click="subPageLocation = 'write'">
                                    撰写卡片
                                </p>
                            </div>
                            <div class="col px-0 px-lg-3">
                                <p class="overflow-hidden py-1 text-center cursor-pointer {{subPageLocation==='myLikes'?'text-white bg-dark':'font-weight-light'}}"
                                    ng-click="subPageLocation = 'myLikes';refreshMyCards();">
                                    我赞过的
                                </p>
                            </div>
                            <div class="col px-0 px-lg-3">
                                <p class="overflow-hidden py-1 text-center cursor-pointer {{subPageLocation==='myShares'?'text-white bg-dark':'font-weight-light'}}"
                                    ng-click="subPageLocation = 'myShares';refreshMyCards();">
                                    我转发的
                                </p>
                            </div>
                        </div>
                    </div>





                    <!-- 标签项内容 -->
                    <!-- 我的所有卡片 -->
                    <div class="col-12 col-sm-12 col-md-12 col-lg-12" ng-show="['myCards','myLikes','myShares'].includes(subPageLocation)">
                        <div class="card-columns" ng-repeat="myCards in myCardGroups track by $index">
                            <div ng-repeat="card in myCards track by $index">
                                <!-- 如果卡片不是转发卡片 -->
                                <wc-card-preview
                                    ng-if="card.type !== 'share'"
                                    card="card"
                                    user="user"></wc-card-preview>
                                <!-- 如果（我的）卡片是转发卡片 -->
                                <wc-shared-card-preview
                                    ng-if="card.type === 'share' && card.share"
                                    card="card"
                                    user="user"></wc-shared-card-preview>
                            </div>
                        </div>
                        <!-- 加载更多我的卡片 -->
                        <div class="w-100 text-center my-4">
                            <div class="btn btn-block btn-outline-primary border-radius-0" ng-click="load_more_my_cards()" ng-if="has_more_my_cards">
                                <span>加载更多卡片</span>
                            </div>
                            <div ng-if="!has_more_my_cards">
                                <span class="text-muted">没有更多卡片了</span>
                            </div>
                        </div>
                    </div>




                    <!-- 撰写卡片 Create Card -->
                    <div class="col-12 col-sm-12 col-md-12 offset-lg-2 col-lg-8" ng-show="subPageLocation === 'write'">
                        <div class="row">
                            <div class="col-12 col-lg-10 mx-auto" style="max-width: 700px!important;">
                                <!-- 选择卡片类型 -->
                                <ul class="nav nav-tabs">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-toggle="tab" href="#create-text-card" ng-click="writeCard_editorType = 'v2.7'">
                                            <span>文字</span><span class="visible hidden-sm">卡片</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-toggle="tab" href="#create-image-card" ng-click="writeCard_editorType = 'v2.7'">
                                            <span>图片</span><span class="visible hidden-sm">卡片</span>
                                        </a>
                                    </li>
                                    <li class="nav-item display-none">
                                        <a class="nav-link" data-toggle="tab" href="#create-video-card" ng-click="writeCard_editorType = 'v2.7'">
                                            <span>视频</span><span class="visible hidden-sm">卡片</span>
                                        </a>
                                    </li>
                                    <li class="nav-item display-none">
                                        <a class="nav-link" data-toggle="tab" href="#create-audio-card" ng-click="writeCard_editorType = 'v2.7'">
                                            <span>音频</span><span class="visible hidden-sm">卡片</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-toggle="tab" href="#create-quill-card" ng-click="writeCard_editorType = 'quill'">
                                            <span>富文本</span><span class="visible hidden-sm">卡片</span>
                                        </a>
                                    </li>
                                </ul>
                                <!-- 卡片 标题, 正文, 话题 编辑区 -->
                                <div class="py-4">
                                    <!-- 错误消息显示区域 -->
                                    <div class="create-card-error-messge-wrapper alert alert-danger" style="display: none;">
                                        <i class="fa fa-times mx-2" onclick="$(this).parent().hide();"></i>
                                        <span class="create-card-error-messge"></span>
                                    </div>
                                    <!-- 卡片标题 -->
                                    <div class="form-group">
                                        <input type="text" class="form-control" ng-model="card_to_create.title" placeholder="卡片标题">
                                    </div>
                                    <!-- 卡片正文 Quill 编辑器 -->
                                    <div class="form-group" ng-show="writeCard_editorType === 'quill'">
                                        <div class="px-2 mb-3">
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary py-0 border-radius-0" onclick="$(this).parent().hide().next().show();">
                                                    <div>设置工具栏</div>
                                                </button>
                                            </div>
                                            <div style="display: none;">
                                                <div class="d-flex align-items-center">
                                                    <button class="btn btn-sm btn-outline-primary py-0" 
                                                            onclick="toggleQuillToolbarFont('#editor-container');$(this).toggleClass('btn-primary btn-outline-primary');">
                                                        <div>字体</div>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-primary py-0 ml-2" 
                                                            onclick="toggleQuillToolbarColor('#editor-container');$(this).toggleClass('btn-primary btn-outline-primary');">
                                                        <div>颜色</div>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-primary py-0 ml-2" 
                                                            onclick="toggleQuillToolbarList('#editor-container');$(this).toggleClass('btn-primary btn-outline-primary');">
                                                        <div>列表</div>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-primary py-0 ml-2" 
                                                            onclick="toggleQuillToolbarCode('#editor-container');$(this).toggleClass('btn-primary btn-outline-primary');">
                                                        <div>代码</div>
                                                    </button>
                                                    <i class="fa fa-lg fa-times-circle ml-auto" onclick="$(this).parent().parent().hide().prev().show();"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="editor-container" style="background-color: #fff; height: {{writeCard_textAreaHeight}}px;">
                                        </div>
                                        <script>
                                            function toggleQuillToolbarFont(selector) {
                                                var toolbar = $(selector).siblings(".ql-toolbar");
                                                toolbar.find(".ql-formats").eq(0).toggle();
                                            }

                                            function toggleQuillToolbarColor(selector) {
                                                var toolbar = $(selector).siblings(".ql-toolbar");
                                                toolbar.find(".ql-color-picker").toggle();
                                            }
                                            
                                            function toggleQuillToolbarList(selector) {
                                                var toolbar = $(selector).siblings(".ql-toolbar");
                                                toolbar.find(".ql-list").toggle();
                                            }

                                            function toggleQuillToolbarCode(selector) {
                                                var toolbar = $(selector).siblings(".ql-toolbar");
                                                toolbar.find(".ql-code").toggle();
                                                toolbar.find(".ql-code-block").toggle();
                                            }

                                            function initQuill(selector) {
                                                try {
                                                    Quill;
                                                } catch (e) {
                                                    return false;
                                                }
                                                // 当 quill 脚本未被加载的时候, 下面的代码会报错
                                                if (Quill !== undefined) {
                                                    var quill = new Quill(selector, {
                                                        modules: {
                                                            toolbar: [
                                                                [{ "font": [] }, { "size": [] }, { "header": [1, 2, 3, false] }],
                                                                [{ 'color': [] }, { 'background': [] }, 'bold', 'italic', 'underline', "strike", "code"],
                                                                [{ 'list': 'ordered' }, { 'list': 'bullet' }, 'image', "blockquote", 'code-block']
                                                            ]
                                                        },
                                                        placeholder: "卡片正文",
                                                        theme: 'snow'  // or 'bubble'
                                                    });

                                                    var imageButton = $("#editor-container").siblings(".ql-toolbar").find(".ql-image");
                                                    imageButton.replaceWith(imageButton.prop("outerHTML"));
                                                    toggleQuillToolbarFont("#editor-container");
                                                    toggleQuillToolbarColor("#editor-container");
                                                    toggleQuillToolbarList("#editor-container");
                                                    toggleQuillToolbarCode("#editor-container");
                                                    return true;
                                                }
                                                return false;
                                            }

                                            setTimeout(() => {
                                                if (initQuill("#editor-container") !== true) {
                                                    $("[href=\"#create-quill-card\"]").parent().hide();
                                                }
                                            }, 1000);
                                        </script>
                                    </div>
                                    <!-- 卡片正文 v 2.7 编辑器 -->
                                    <div class="form-group" ng-show="writeCard_editorType === 'v2.7'">
                                        <textarea class="form-control legacy-form-control" rows="6" ng-model="card_to_create.text" placeholder="卡片正文"
                                                  style="height: {{writeCard_textAreaHeight}}px;">
                                        </textarea>
                                        <div class="form-control form-control-v2-7" id="card-to-create-text-v2-7" 
                                             style="display: none;height: {{writeCard_textAreaHeight}}px;">
                                        </div>
                                    </div>
                                    <!-- 切换编辑器按钮区 -->
                                    <div class="form-group row" ng-show="writeCard_editorType === 'v2.7'">
                                        <div class="col-12">
                                            <div class="form-inline">
                                                <script>
                                                    function toggleNewEditor (btn) {
                                                        $('.legacy-form-control').hide().next().show();
                                                        $(btn).parent().find('.editor-toggle-old').hide();
                                                        $(btn).parent().find('.editor-toggle-new').show();
                                                    }

                                                    function toggleOldEditor (btn) {
                                                        $('.legacy-form-control').show().next().hide();
                                                        $(btn).parent().find('.editor-toggle-new').hide();
                                                        $(btn).parent().find('.editor-toggle-old').show();
                                                    }
                                                </script>
                                                <button class="btn btn-sm btn-outline-primary editor-toggle editor-toggle-old mr-1 mr-lg-2 mb-1 mb-lg-0"
                                                        id="editor-toggle-1"
                                                        onclick="toggleNewEditor(this);">
                                                    开启新版编辑器
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger editor-toggle editor-toggle-old mr-auto mb-1 mb-lg-0"
                                                        id="editor-toggle-2"
                                                        onclick="toggleNewEditor(this);v2_7.reload();">
                                                    复制当前内容到新版编辑器
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary editor-toggle editor-toggle-new mr-1 mr-lg-2 mb-1 mb-lg-0"
                                                        id="editor-toggle-3"
                                                        onclick="toggleOldEditor(this);"
                                                        style="display: none;">
                                                    开启旧版卡片编辑器
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary editor-toggle editor-toggle-new mr-auto mb-1 mb-lg-0"
                                                        id="editor-toggle-4"
                                                        onclick="v2_7.initHelp();v2_7.help();"
                                                        style="display: none;">
                                                    新版卡片编辑器功能介绍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 卡片话题 -->
                                    <div class="form-group row">
                                        <div class="col-6 col-lg-4 pr-0 d-flex align-items-center">
                                            <input type="text" class="form-control form-control-sm w-75 d-inline" ng-model="my_topic" placeholder="{{my_topic_placeholder}}">
                                            <button class="button button-circle button-primary button-tiny ml-2" ng-click="addCardTopic()">
                                                <i class="fa fa-plus"></i>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-8" ng-show="card_to_create.topics">
                                            <span class="text-muted mx-1" ng-show="!card_to_create.topics.length">
                                                <small>没有话题</small>
                                            </span>
                                            <span class="badge badge-secondary badge-pill mx-1 px-2 py-1" ng-repeat="topic in card_to_create.topics track by $index" onselectstart="return false;">
                                                <span title="index: {{$index}}">{{topic}}</span>
                                                <i class="fa fa-lg fa-times cursor-pointer" ng-click="removeCardTopic($index)"></i>
                                            </span>
                                            <span class="btn btn-sm btn-outline-danger float-right upper" ng-click="removeAllCardTopics()">清空话题</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- 选择卡片类型对应的文件 -->
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="create-text-card">
                                        <div class="p-3">
                                            <small class="text-muted">卡片标题不能超过 {{max.card.title.length}} 字，</small>
                                            <small class="text-muted">卡片正文不能超过 {{max.card.text.length}} 字，</small>
                                            <small class="text-muted">卡片话题不能超过 {{max.card.topics.length}} 个</small>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="create-image-card">
                                        <div class="mb-2 text-muted">
                                            <small class="d-inline-block">选择图片</small>
                                            <small class="d-inline-block">已选择 <span id="card_to_create_files_length">0</span> 张</small>
                                            <small class="d-inline-block">最多 {{max.card.images.length}} 张</small>
                                            <button class="btn btn-sm btn-outline-danger float-right upper" onclick="selectImage_cleanSelected()">
                                                清空所有图片
                                            </button>
                                        </div>
                                        <div class="form-group row" ng-repeat="i in [0,1]">
                                            <div class="col-12 text-center col-lg-4" ng-repeat="j in [0,1,2]">
                                                <div class="card-image-preview-wrapper img-thumbnail card-image-select"
                                                     onclick="$(this).find('input.select-image')[0].click()" ng-init="index = i * 3 + j">
                                                    <span class="text-muted half-hidden hover-show no-image-text">未选择图片</span>
                                                    <img class="card-image-preview" style="display: none;" src="null" onerror="refreshSelectVisibility('init')">
                                                    <input type="file" class="select-image" accept="image/png,image/jpg,image/gif" style="display: none;"
                                                           onchange="selectImage_fileSelected(this)">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="create-video-card">
                                        <div class="mb-2 text-muted">
                                            <small>选择视频</small>
                                        </div>
                                        <div class="form-group">
                                            <input type="file" class="form-control" ng-model="card_to_create.file" placeholder="">
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="create-audio-card">
                                        <div class="mb-2 text-muted">
                                            <small>选择音频</small>
                                        </div>
                                        <div class="form-group">
                                            <input type="file" class="form-control" ng-model="card_to_create.file" placeholder="">
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="create-quill-card">
                                        <div class="p-3">
                                            <small class="text-muted">卡片标题不能超过 {{max.card.title.length}} 字，</small>
                                            <small class="text-muted">卡片正文不能超过 {{max.card.text.length}} 字，</small>
                                            <small class="text-muted">卡片话题不能超过 {{max.card.topics.length}} 个</small>
                                        </div>
                                    </div>
                                </div>
                                <!-- 上传卡片 -->
                                <div class="row py-4">
                                    <div class="col offset-lg-6 px-5 px-lg-4">
                                        <div ng-if="['v2.7','quill'].includes(writeCard_editorType) === true">
                                            <button class="btn btn-primary btn-block" onclick="createCard()">上传卡片</button>
                                        </div>
                                        <div ng-if="['v2.7','quill'].includes(writeCard_editorType) === false">
                                            <div class="alert alert-danger">无法上传卡片</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>





                </div>
            </div>
<!--            end of page "cards" -->







            <!-- 查看卡片 -->
            <wc-card-view-modal current-card="current_card"
                                user="user">
            </wc-card-view-modal>






            <!-- 提交转发卡片时的模态窗 -->
            <wc-share-card-modal user="user"
                                 user-data="userData">
            </wc-share-card-modal>
            <!-- 转发卡片 选择转发给的好友的模态窗 -->
            <wc-share-card-to-friends-modal user-data="userData">
            </wc-share-card-to-friends-modal>














            <!-- 消息列表 -->
            <div class="chat-list container-fluid mt-3" ng-show="['homepage','trans-home-chat','trans-chat-home'].includes(pageLocation)">
                <div class="row">
                    <div class="col-12 col-sm-12 col-md-12 offset-lg-2 col-lg-8">

                        <!-- group tabs -->
                        <div class="row mb-3 mx-auto" style="width: 100%; padding-left: 1rem;">
                            <div class="col px-0 d-flex align-items-center justify-content-center {{subPageLocation==='chatItemList'?'text-dark':'text-muted'}}">
                                <div class="cursor-pointer overflow-hidden" ng-click="subPageLocation = 'chatItemList'">
                                    <i class="fa fa-lg fa-comments"></i>
                                    <span class="visible hidden-sm">消息</span>
                                </div>
                            </div>
                            <div class="col-3 px-0 d-flex align-items-center justify-content-center text-muted" ng-if="currentChatItemId === 'external' && prevChatItemId !== 'external'">
                                <div class="cursor-pointer overflow-hidden" ng-click="openPrevChatRoom()">
                                    <div class="d-inline-block" ng-switch="prevChatItemType">
                                        <div ng-switch-when="friend">
                                            <img class="user-avatar-xs rounded-circle border" src="{{prevChatItemAvatar}}" alt="×">
                                        </div>
                                        <div ng-switch-when="room">
                                            <img class="user-avatar-xs rounded border" src="{{prevChatItemAvatar}}" alt="×">
                                        </div>
                                        <div ng-switch-default>
                                            <img class="user-avatar-xs rounded-circle border" src="img/icon-{{prevChatItemType}}.jpg" alt="×">
                                        </div>
                                    </div>
                                    <small>{{prevChatItemName}}</small>
                                </div>
                            </div>
                            <div class="col px-0 d-flex align-items-center justify-content-center {{subPageLocation==='friendGroups'?'text-dark':'text-muted'}}">
                                <div class="cursor-pointer overflow-hidden" ng-click="subPageLocation = 'friendGroups'">
                                    <i class="fa fa-lg fa-user"></i>
                                    <span class="visible hidden-sm">好友</span>
                                </div>
                            </div>
                            <div class="col px-0 d-flex align-items-center justify-content-center {{subPageLocation==='roomGroups'?'text-dark':'text-muted'}}">
                                <div class="cursor-pointer overflow-hidden" ng-click="subPageLocation = 'roomGroups'">
                                    <i class="fa fa-lg fa-home"></i>
                                    <span class="visible hidden-sm">房间</span>
                                </div>
                            </div>
                            <div class="col-3 px-0 d-flex align-items-center justify-content-center {{subPageLocation==='informGroups'?'text-dark':'text-muted'}}">
                                <div class="cursor-pointer overflow-hidden" ng-click="subPageLocation = 'informGroups'">
                                    <i class="fa fa-lg fa-bullhorn"></i>
                                    <span class="visible hidden-sm">通知</span>
                                </div>
                            </div>
                        </div>

                        <!-- 聊天项列表 -->
                        <!-- chat item list -->
                        <div ng-show="subPageLocation === 'chatItemList'">
                            <div class="card border-0" ng-show="!userData.chatList.length">
                                <div class="card-body alert alert-secondary py-3 mb-0 half-hidden">
                                    <p class="card-text text-center">
                                        <i class="fa fa-exclamation-triangle mr-2"></i>
                                        <span>你的聊天列表为空</span>
                                    </p>
                                </div>
                            </div>
                            <ul class="list-group">
                                <li class="list-group-item border-radius-0 {{['system','inform'].includes(chatItem.type)?'list-group-item-info':''}}" ng-repeat="chatItem in userData.chatList track by $index">
                                    <div class="row w-100">
                                        <div class="col-11 d-flex cursor-pointer" ng-click="openChatRoom(chatItem)">
                                            <div class="row w-100 align-self-center">
                                                <!-- 头像 -->
                                                <div class="col-3">
                                                    <div class="avatar-wrapper text-center">
                                                        <div ng-switch="chatItem.type">
                                                            <div ng-switch-when="friend">
                                                                <img class="user-avatar rounded-circle border" ng-src="{{chatItem.friend.avatarUrl}}" alt="×">
                                                            </div>
                                                            <div ng-switch-when="room">
                                                                <img class="user-avatar rounded border" ng-src="{{chatItem.room.roomImgUrl}}" alt="×">
                                                            </div>
                                                            <div ng-switch-default>
                                                                <img class="user-avatar rounded-circle border" ng-src="img/icon-{{chatItem.type}}.jpg" alt="×">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- 用户名和消息（在同一个列的不同的行） -->
                                                <div class="col-8 pl-4 pl-sm-3 pl-md-4 pr-0">
                                                    <!-- 用户名 -->
                                                    <div class="row">
                                                        <!-- 好友消息 -->
                                                        <div class="overflow-hidden" ng-if="chatItem.type == 'friend'">
                                                            <span ng-if="chatItem.friend.remark">
                                                                <span data-toggle="tooltip" data-placement="left" title="{{chatItem.friend.remark}}">
                                                                    {{chatItem.friend.remark}}
                                                                </span>
                                                            </span>
                                                            <span ng-if="!chatItem.friend.remark">
                                                                <span class="text-danger" data-toggle="tooltip" data-placement="left" title="{{chatItem.friend.username}}">
                                                                    {{chatItem.friend.username}}
                                                                </span>
                                                            </span>
                                                        </div>
                                                        <!-- 房间消息 -->
                                                        <div class="overflow-hidden" ng-if="chatItem.type == 'room'">
                                                            <span class="text-muted">
                                                                <i class="fa fa-home"></i>
                                                            </span>
                                                            <span data-toggle="tooltip" data-placement="left" title="{{chatItem.room.roomName}}">
                                                                {{chatItem.room.roomName}}
                                                            </span>
                                                        </div>
                                                        <!-- 系统消息 -->
                                                        <div class="overflow-hidden" ng-if="chatItem.type == 'system'">
                                                            <span class="text-muted">
                                                                <i class="fa fa-gear"></i>
                                                            </span>
                                                            <span data-toggle="tooltip" data-placement="left" title="系统消息">
                                                                系统消息
                                                            </span>
                                                        </div>
                                                        <!-- 验证消息 -->
                                                        <div class="overflow-hidden" ng-if="chatItem.type == 'inform'">
                                                            <span class="text-muted">
                                                                <i class="fa fa-bell-o"></i>
                                                            </span>
                                                            <span data-toggle="tooltip" data-placement="left" title="验证消息">
                                                                验证消息
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <!-- 消息 -->
                                                    <div class="row">
                                                        <!-- 消息 -->
                                                        <div class="col-12 px-0 d-flex align-items-center">
                                                            <!-- 普通消息 -->
                                                            <div class="d-inline-block w-100 overflow-hidden" ng-if="chatItem.message">
                                                                <small class="text-muted">
                                                                    <span ng-if="chatItem.message.user">
                                                                        <span ng-if="chatItem.type === 'friend'">
                                                                            <span ng-if="chatItem.message.user === chatItem.friend">
                                                                                {{chatItem.friend.remark}}:
                                                                            </span>
                                                                            <span ng-if="chatItem.message.user !== chatItem.friend">
                                                                                你:
                                                                            </span>
                                                                        </span>
                                                                    </span>
                                                                    <span ng-switch="chatItem.message.type">
                                                                        <span ng-switch-when="text">
                                                                            {{chatItem.message.text}}
                                                                        </span>
                                                                        <span ng-switch-when="image">
                                                                            图片消息
                                                                        </span>
                                                                        <span ng-switch-when="video">
                                                                            视频消息
                                                                        </span>
                                                                        <span ng-switch-when="voice">
                                                                            音频消息
                                                                        </span>
                                                                        <span ng-switch-default>
                                                                            其他消息
                                                                        </span>
                                                                    </span>
                                                                </small>
                                                            </div>
                                                            <!-- 请求消息 -->
                                                            <div class="d-inline-block w-100 overflow-hidden" ng-if="chatItem.type === 'inform'">
                                                                <span ng-if="chatItem.request" title="{{chatItem.request.type}}">
                                                                    <small class="text-muted">
                                                                        <span ng-if="chatItem.request.requester.id === userData.user.id">
                                                                            你
                                                                        </span>
                                                                        <span ng-if="chatItem.request.requester.id !== userData.user.id">
                                                                            <span ng-if="chatItem.request.requester.nickname">
                                                                                {{chatItem.request.requester.nickname}}
                                                                            </span>
                                                                            <span class="text-danger" ng-if="!chatItem.request.requester.nickname">
                                                                                <span class="text-danger" ng-if="chatItem.request.requester.username">
                                                                                    {{chatItem.request.requester.username}}
                                                                                </span>
                                                                                <span class="text-danger" ng-if="!chatItem.request.requester.username">
                                                                                    未知用户
                                                                                </span>
                                                                            </span>
                                                                        </span>
                                                                        请求
                                                                        <!-- 加好友请求 -->
                                                                        <span ng-if="chatItem.request.type === 'friend'">
                                                                            添加
                                                                            <span ng-if="chatItem.request.receiver.id === userData.user.id">
                                                                                你
                                                                            </span>
                                                                            <span ng-if="chatItem.request.receiver.id !== userData.user.id">
                                                                                {{chatItem.request.receiver.nickname}}
                                                                            </span>
                                                                            为好友
                                                                        </span>
                                                                        <!-- 加房间请求 -->
                                                                        <span ng-if="chatItem.request.type === 'room'">
                                                                            加入
                                                                            <i class="fa fa-home"></i>
                                                                            {{chatItem.request.room.roomName}}
                                                                        </span>
                                                                    </small>
                                                                </span>
                                                            </div>
                                                            <!-- 系统消息 -->
                                                            <div class="d-inline-block w-100 overflow-hidden" ng-if="chatItem.type === 'system'">
                                                                <span ng-if="chatItem.systemNotification">
                                                                    <small class="text-muted">
                                                                        {{chatItem.systemNotification.systemMsg}}
                                                                    </small>
                                                                </span>
                                                            </div>
                                                            <div class="d-inline-block w-100 overflow-hidden" ng-if="!chatItem.message">
                                                                <span ng-if="chatItem.type === 'friend'">
                                                                    <small class="text-muted" style="opacity: 0.5;">
                                                                        没有消息
                                                                    </small>
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- 未读消息数 -->
                                                <div class="col-1 p-0 d-flex align-items-center">
                                                    <span ng-if="chatItem.unreadNum > 0" class="badge badge-pill badge-info">
                                                        {{chatItem.unreadNum}}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-1 p-0 half-hidden hover-show">
                                            <button class="button button-large button-primary button-glow button-border button-square float-right" ng-click="removeChatItem(chatItem.id)">
                                                <i class="fa fa-lg fa-trash-o"></i>
                                            </button>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>

                        <!-- 好友分组 -->
                        <!-- friend groups -->
                        <div ng-show="subPageLocation === 'friendGroups'">

                            <div class="row mb-3">
                                <div class="col-3 col-lg-4"></div>
                                <div class="col-6 col-lg-4">
                                    <input type="text" class="form-control form-control-sm w-100" id="search-user-keyword" ng-model="searchUserKeyword" ng-change="searchUser()"
                                           placeholder="搜索用户及好友">
                                </div>
                            </div>


                            <!-- search user results -->
                            <div class="search-results container-fluid" ng-show="isSearchingUser === true" style="position:relative;">
                                <div class="search-results-container w-100">
                                    <div class="search-results-wrapper">
                                        <!-- stop search users -->
                                        <div class="stop-search-button-wrapper">
                                            <i class="fa fa-lg fa-times-circle mb-1 text-muted" ng-click="stopSearchUser()"></i>
                                        </div>
                                        <ul class="list-group" ng-if="isSearchingUserLoading">
                                            <!-- search card: loading -->
                                            <li class="list-group-item list-group-item-secondary text-center">
                                                <span class="fa fa-spinner fa-pulse fa-fw"></span>
                                                搜索中 ...
                                            </li>
                                        </ul>
                                        <ul class="list-group" ng-if="!isSearchingUserLoading">
                                            <li class="list-group-item bg-dark text-white cursor-pointer" ng-repeat="friend in searchUserResults track by $index">
                                                <div class="row">
                                                    <div class="col-6 d-flex align-items-center justify-content-start">
                                                        <img class="user-avatar rounded-circle cursor-pointer" ng-src="{{friend.avatarUrl}}" alt="image not found" data-toggle="popover"
                                                             data-content="{{getUserInfoAvatar(friend)}}">
                                                        <span class="d-inline-block overflow-hidden ml-2" style="min-width:100px;">
                                                            <span class="text-white" data-toggle="tooltip" data-placement="bottom" title="用户昵称">
                                                                {{friend.nickname}}
                                                            </span>
                                                            <small class="text-light" data-toggle="tooltip" data-placement="bottom" title="用户名（QQ账户除外）">
                                                                ({{friend.username}})
                                                            </small>
                                                        </span>
                                                    </div>
                                                    <div class="col-6 d-flex align-items-center justify-content-between justify-content-sm-end">
                                                        <!-- 如果该用户不是自己，而且他不是我的好友，就显示添加好友按钮 -->
                                                        <div class="btn btn-sm btn-outline-success mx-1 mx-md-2 mx-lg-3" data-toggle="popover" title="{{getAddFriendTitle(friend)}}" data-content="{{getAddFriendContent(friend)}}"
                                                             ng-if="userData.user.id !== friend.id && add_friend_is_ok(userData.user.id, friend.id)">
                                                            <span>添加好友</span>
                                                            <i class="fa fa-plus"></i>
                                                        </div>
                                                        <!-- 如果该用户不是自己，而且他是我的好友，就显示开始聊天按钮 -->
                                                        <div class="btn btn-sm btn-outline-primary mx-1 mx-md-2 mx-lg-3" ng-click="startChatWithFriend(friend.id)" ng-if="userData.user.id !== friend.id && !add_friend_is_ok(userData.user.id, friend.id)">
                                                            <span>开始聊天</span>
                                                            <i class="fa fa-comments"></i>
                                                        </div>
                                                        <!-- 如果是自己，就禁用添加好友按钮 -->
                                                        <button class="btn btn-sm btn-outline-secondary mx-1 mx-md-2 mx-lg-3" ng-if="userData.user.id === friend.id" disabled>
                                                            <span>添加好友</span>
                                                            <i class="fa fa-plus"></i>
                                                        </button>
                                                        <!-- 点击查看此用户的更多信息 -->
                                                        <button class="button button-glow button-circle button-action button-tiny mx-1 mx-md-2 mx-lg-3" data-toggle="popover" title="{{getUserInfoTitle(friend)}}"
                                                                data-content="{{getUserInfoContent(friend)}}">
                                                            <i class="fa fa-search"></i>
                                                        </button>
                                                        <!-- 显示该用户的等级 -->
                                                        <span class="mx-1 mx-md-2 mx-lg-3" data-toggle="tooltip" title="用户等级" data-placement="bottom">
                                                            <i class="fa fa-star text-warning"></i>
                                                            <span>{{friend.grade}}</span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </li>
                                            <!-- search user no result -->
                                            <li class="list-group-item list-group-item-danger text-center" ng-if="!searchUserResults || searchUserResults.length === 0">
                                                没有搜索到用户
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>


                            <div id="accordion">
                                <div class="card border-0" ng-show="!userData.groups.length">
                                    <div class="card-body alert alert-danger py-3 mb-0">
                                        <p class="card-text text-center">
                                            <i class="fa fa-exclamation-triangle mr-2"></i>
                                            你没有好友分组，请添加好友分组
                                        </p>
                                    </div>
                                </div>

                                <div class="card" ng-repeat="group in userData.groups track by $index">
                                    <div class="card-header">
                                        <h5 class="d-flex align-items-center mb-0">
                                            <!-- 只读模式 -->
                                            <span ng-show="allow.set.user.group.name.enableBy.groupId !== group.id">
                                                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse-{{$index}}">
                                                    {{group.groupName}}
                                                </button>
                                            </span>
                                            <!-- 编辑模式 -->
                                            <span class="d-flex align-items-center" ng-show="allow.set.user.group.name.enableBy.groupId === group.id">
                                                <input type="text" class="form-control w-75 friend-group-name" ng-model="group.groupName" data-friend-group-id="{{group.id}}"
                                                       style="display: inline-block!important;">
                                                <div class="ml-2">
                                                    <button class="button button-glow button-royal button-circle button-small" ng-click="allow.set.user.group.name.submit(group)">
                                                        <i class="fa fa-check"></i>
                                                    </button>
                                                </div>
                                            </span>
                                            <small class="align-self-center ml-auto px-3 text-muted">{{group.friendNum}}</small>
                                        </h5>
                                    </div>

                                    <div id="collapse-{{$index}}" class="collapse" ng-class="{'show': $first}" data-parent="#accordion">
                                        <div class="card-body p-2">
                                            <ul class="list-group">
                                                <li class="list-group-item cursor-pointer" ng-repeat="friend in group.friends track by $index" ng-click="clickFriend($event,friend.id)">
                                                    <div class="row">
                                                        <!-- 好友分组中的好友 头像 -->
                                                        <div class="col-2 pr-0">
                                                            <img class="user-avatar rounded-circle cursor-pointer" ng-src="{{friend.avatarUrl}}" alt="image not found" data-toggle="popover"
                                                                 data-content="{{getUserInfoAvatar(friend)}}">
                                                        </div>
                                                        <!-- 好友分组中的好友 用户名 -->
                                                        <div class="col-5 pl-4 pr-0">
                                                            <div class="row" style="min-width: 300px;">
                                                                <a href="#">
                                                                    <span>{{friend.remark}}</span>
                                                                    <small class="text-muted">({{friend.username}})</small>
                                                                </a>
                                                            </div>
                                                            <div class="row" ng-if="debugMode.isEnabled">
                                                                <small class="text-muted half-hidden">{{friend.id}}</small>
                                                            </div>
                                                        </div>
                                                        <!-- 好友分组中的好友 其他操作 -->
                                                        <div class="col-5 d-flex align-items-end justify-content-around">
                                                            <div class="friend-info-button-wrapper d-inline-block">
                                                                <button class="button button-glow button-circle button-action button-tiny" data-toggle="dropdown">
                                                                    <i class="fa fa-chevron-down"></i>
                                                                </button>
                                                                <div class="dropdown-menu">
                                                                    <div class="dropdown-item" ng-click="open_set_friend_remark_modal(friend)">设置备注</div>
                                                                    <div class="dropdown-item" ng-click="move_friend_to_group_select_group(friend)">移动分组</div>
                                                                    <div class="dropdown-item" ng-click="startChatWithFriend(friend.id)">发送消息</div>
                                                                    <div class="dropdown-item" ng-click="show_friend_info(friend.id)">查看个人页面</div>
                                                                    <div class="dropdown-divider"></div>
                                                                    <div class="dropdown-item" ng-click="remove_friend(friend.id)">删除好友</div>
                                                                    <div class="dropdown-item">举报</div>
                                                                </div>
                                                            </div>
                                                            <div class="friend-info-button-wrapper d-inline-block">
                                                                <button class="button button-glow button-circle button-action button-tiny" data-toggle="popover" title="{{getUserInfoTitle(friend)}}"
                                                                        data-content="{{getUserInfoContent(friend)}}">
                                                                    <i class="fa fa-search"></i>
                                                                </button>
                                                            </div>
                                                            <div class="friend-info-digit d-inline-block">
                                                                <i class="fa fa-star text-warning"></i>
                                                                <span class="digit">{{friend.grade}}</span>
                                                            </div>
                                                            <div class="friend-info-digit d-inline-block">
                                                                <i class="fa fa-heart text-primary"></i>
                                                                <span class="digit">{{friend.fansNum}}</span>
                                                            </div>
                                                            <div class="friend-info-digit d-inline-block">
                                                                <i class="fa fa-users text-primary"></i>
                                                                <span class="digit">{{friend.followNum}}</span>
                                                            </div>
                                                            <div class="friend-info-digit d-inline-block">
                                                                <i class="fa fa-image text-primary"></i>
                                                                <span class="digit">{{friend.cardsNum}}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li class="list-group-item d-flex align-items-center justify-content-center">
                                                    <div class="row w-100">
                                                        <div class="col-12 col-sm-3 d-flex align-items-center justify-content-start px-0">
                                                            <span class="text-muted" ng-if="!group.friends.length">
                                                                该分组为空
                                                            </span>
                                                        </div>
                                                        <div class="col-12 col-sm-5 d-flex align-items-center justify-content-start px-0" ng-if="debugMode.isEnabled">
                                                            <small class="text-muted half-hidden">
                                                                <span>分组 ID: </span>
                                                                <span>{{group.id}}</span>
                                                            </small>
                                                        </div>
                                                        <div class="col-12 col-sm-4 d-flex align-items-center justify-content-end ml-auto pr-0">
                                                            <span class="d-inline-block mr-2">
                                                                <button class="btn btn-sm btn-outline-info" ng-click="allow.set.user.group.name.enable(group)">
                                                                    修改分组名
                                                                </button>
                                                            </span>
                                                            <span class="d-inline-block">
                                                                <button class="btn btn-sm btn-outline-danger" ng-if="!group.friends.length" ng-click="removeGroup(group.id)">
                                                                    删除分组
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-danger" ng-if="group.friends.length" disabled style="opacity: 0.2;">
                                                                    删除分组
                                                                </button>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Add Group Toggle -->
                            <div class="row">
                                <div class="col d-flex justify-content-end">
                                    <div class="pr-3 py-2">
                                        <span class="text-muted pr-1">搜索用户及好友</span>
                                        <button class="button button-glow button-circle button-action" onclick="$('#search-user-keyword').focus()">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                    <div class="px-4 py-2">
                                        <span class="text-muted pr-1">添加分组</span>
                                        <button class="button button-glow button-action button-circle" data-toggle="modal" data-target="#add-group-modal">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Add Group Modal -->
                            <div class="modal fade" id="add-group-modal">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">请输入分组名称</h5>
                                            <button type="button" class="close" data-dismiss="modal">
                                                <span>&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="text" class="form-control" ng-class="{true:'is-valid',false:'is-invalid'}[addGroup.isValid]" placeholder="{{addGroup.placeholder}}"
                                                   ng-model="addGroup.groupName">
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                                            <button type="button" class="btn btn-primary" ng-click="createGroup()">添加分组</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- room portal list -->
                        <div ng-show="subPageLocation === 'roomGroups'">
                            <div class="row mb-3">
                                <div class="col-3 col-lg-4"></div>
                                <div class="col-6 col-lg-4">
                                    <input type="text" class="form-control form-control-sm w-100" id="search-room-keyword" ng-model="searchRoomKeyword" ng-change="searchRoom()"
                                           placeholder="搜索聊天室">
                                </div>
                            </div>

                            <!-- search room results -->
                            <div class="search-results container-fluid" ng-show="isSearchingRoom === true" style="position:relative;">
                                <div class="search-results-container w-100">
                                    <div class="search-results-wrapper">
                                        <!-- stop search rooms -->
                                        <div class="stop-search-button-wrapper">
                                            <i class="fa fa-lg fa-times-circle mb-1 text-muted" ng-click="stopSearchRooms()"></i>
                                        </div>
                                        <ul class="list-group" ng-if="isSearchingRoomLoading">
                                            <!-- search card: loading -->
                                            <li class="list-group-item list-group-item-secondary text-center">
                                                <span class="fa fa-spinner fa-pulse fa-fw"></span>
                                                搜索中 ...
                                            </li>
                                        </ul>
                                        <ul class="list-group" ng-if="!isSearchingRoomLoading">
                                            <!-- search room result item -->
                                            <li class="list-group-item bg-dark text-white cursor-pointer" ng-repeat="room in searchRoomResults track by $index">
                                                <div class="row">
                                                    <div class="col-6 d-flex align-items-center justify-content-start">
                                                        <img class="user-avatar rounded cursor-pointer" src="{{room.roomImgUrl}}" alt="image not found">
                                                        <span class="d-inline-block overflow-hidden ml-2" style="max-width:300px;">
                                                            <span class="text-white">{{room.roomName}}</span>
                                                            <small class="text-light" ng-if="debugMode.isEnabled">({{room.id}})</small>
                                                        </span>
                                                    </div>
                                                    <div class="col-6 d-flex align-items-center justify-content-between">
                                                        <!-- 如果我未加入这个房间，就显示加入房间按钮 -->
                                                        <div class="btn btn-sm btn-outline-primary" data-toggle="popover" title="{{getJoinRoomTitle(room)}}" data-content="{{getJoinRoomContent(room)}}"
                                                             ng-if="join_room_is_ok(userData.user.id, room.id)">
                                                            <span>加入房间</span>
                                                            <i class="fa fa-plus"></i>
                                                        </div>
                                                        <!-- 如果我已经加入了这个房间，就显示进入聊天室按钮 -->
                                                        <div class="btn btn-sm btn-outline-primary" ng-click="startChatInChatRoom(room.id)"
                                                             ng-if="!join_room_is_ok(userData.user.id, room.id)">
                                                            <span>进入房间</span>
                                                            <i class="fa fa-comments"></i>
                                                        </div>
                                                        <button class="button button-glow button-circle button-action button-tiny" data-toggle="popover" title="{{getUserInfoTitle(room.owner)}}"
                                                                data-content="{{getUserInfoContent(room.owner)}}">
                                                            <i class="fa fa-search"></i>
                                                        </button>
                                                        <i class="fa fa-star text-warning"></i>
                                                    </div>
                                                </div>
                                            </li>
                                            <!-- search room: no search result -->
                                            <li class="list-group-item list-group-item-danger text-center" ng-if="!searchRoomResults || searchRoomResults.length === 0">
                                                没有搜索到房间
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>




                            <div class="card border-0" ng-show="!userData.rooms.length">
                                <div class="card-body alert alert-danger py-3 mb-0">
                                    <p class="card-text text-center">
                                        <i class="fa fa-exclamation-triangle mr-2"></i>
                                        你没有加入任何房间
                                    </p>
                                </div>
                            </div>
                            <!-- room list -->
                            <ul class="list-group">
                                <li class="list-group-item cursor-pointer" ng-repeat="room in userData.rooms track by $index" ng-click="clickRoom($event.target,room.id)">
                                    <div class="row">
                                        <div class="col-2">
                                            <img class="user-avatar rounded cursor-pointer" src="{{room.roomImgUrl}}" alt="x">
                                        </div>
                                        <div class="col-6 d-flex align-items-center">
                                            <a href="#">
                                                <span>{{room.roomName}}</span>
                                                 <small class="text-muted" ng-if="debugMode.isEnabled">
                                                     ({{room.status}})
                                                 </small>
                                            </a>
                                        </div>
                                        <div class="col-4 d-flex align-items-center justify-content-around">
                                            <small class="text-muted" ng-if="debugMode.isEnabled">
                                                {{room.id}}
                                            </small>
                                        </div>
                                    </div>
                                </li>
                            </ul>

                            <!-- Create Room Toggle -->
                            <div class="row">
                                <div class="col d-flex justify-content-end">
                                    <div class="pr-3 py-2">
                                        <span class="text-muted pr-1">搜索房间</span>
                                        <button class="button button-glow button-circle button-action" onclick="$('#search-room-keyword').focus()">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                    <div class="pr-4 py-2">
                                        <span class="text-muted pr-1">创建房间</span>
                                        <button class="button button-glow button-circle button-action button-border" data-toggle="modal" data-target="#create-room-modal">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Create Room Modal -->
                            <div class="modal fade" id="create-room-modal">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">请输入房间名</h5>
                                            <button type="button" class="close" data-dismiss="modal">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="text" class="form-control" ng-class="{true:'is-valid',false:'is-invalid'}[createRoom.isValid]" placeholder="{{createRoom.placeholder}}"
                                                   ng-model="createRoom.roomName">
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                                            <button type="button" class="btn btn-primary" ng-click="createRoomSubmit()">创建房间</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- inform portal list -->
                        <div ng-show="subPageLocation === 'informGroups'">
                            <div class="mt-4">
                                <!-- 如果用户没有 inform chat item -->
                                <div class="card border-0" ng-show="!userData.has_chat_item_type('inform')">
                                    <div class="card-body alert alert-danger py-3 mb-0">
                                        <p class="card-text text-center">
                                            <i class="fa fa-exclamation-triangle mr-2"></i>
                                            验证消息频道遗失
                                        </p>
                                    </div>
                                </div>
                                <!-- 如果用户没有 system chat item -->
                                <div class="card border-0" ng-show="!userData.has_chat_item_type('system')">
                                    <div class="card-body alert alert-danger py-3 mb-0">
                                        <p class="card-text text-center">
                                            <i class="fa fa-exclamation-triangle mr-2"></i>
                                            系统通知频道遗失
                                        </p>
                                    </div>
                                </div>

                                <ul class="list-group">
                                    <li class="list-group-item cursor-pointer" ng-repeat="portal in userData.allChatItems track by $index" ng-if="portal.type === 'inform'" ng-click="openChatRoom(portal)">
                                        <div class="row">
                                            <div class="col-2">
                                                <img class="user-avatar rounded-circle cursor-pointer" src="img/icon-{{portal.type}}.jpg" alt="image not found">
                                            </div>
                                            <div class="col-6 d-flex align-items-center">
                                                <span>验证消息</span>
                                            </div>
                                            <div class="col-4 d-flex align-items-center justify-content-around">
                                                <small class="text-muted" ng-if="debugMode.isEnabled">
                                                    {{portal.id}}
                                                </small>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="list-group-item cursor-pointer" ng-repeat="portal in userData.allChatItems track by $index" ng-if="portal.type === 'system'" ng-click="openChatRoom(portal)">
                                        <div class="row">
                                            <div class="col-2">
                                                <img class="user-avatar rounded-circle cursor-pointer" src="img/icon-{{portal.type}}.jpg" alt="image not found">
                                            </div>
                                            <div class="col-6 d-flex align-items-center">
                                                <span>系统消息</span>
                                            </div>
                                            <div class="col-4 d-flex align-items-center justify-content-around">
                                                <small class="text-muted" ng-if="debugMode.isEnabled">
                                                    {{portal.id}}
                                                </small>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>









            <!-- 聊天窗口 -->
            <wc-chat-window ng-show="['chat','trans-home-chat','trans-chat-home'].includes(pageLocation)"
                            current-chat-item-type="currentChatItemType"
                            chat-message-list="chatMessageList"
                            current="current"
                            max="max"
                            user-data="userData"
                            unread-message-count="unread_message_count">
            </wc-chat-window>






            <!-- 好友分组 -->
            <div class="groups container-fluid mt-3" ng-show="pageLocation === 'groups'">
                <div class="row">
                    <div class="col-12 col-sm-12 col-md-12 offset-lg-2 col-lg-8">


                        <!-- notification portal list -->
                        <div ng-show="subPageLocation === 'systemMessageGroups'">
                            <div class="mt-4">

                            </div>
                        </div>


                    </div>
                </div>
            </div>









            <!-- settings(个人中心) -->
            <div class="settings container-fluid mt-3" ng-show="pageLocation === 'settings'">
                <div class="row">
                    <!-- User Info -->
                    <div class="col-12 col-sm-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3 mb-3" ng-show="user">
                        <div class="card border-radius-0">
                            <div class="card-header">
                                <i class="fa fa-user-circle mr-1"></i>
                                <div class="d-inline-block">用户基本信息</div>
                            </div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">用户名</div>
                                        <div class="col-6 text-center">{{userData.user.username}}</div>
                                    </div>
                                </li>
                                <li class="list-group-item" ng-if="debugMode.isEnabled">
                                    <div class="row">
                                        <div class="col-6">用户 ID</div>
                                        <div class="col-6 text-center">
                                            {{userData.user.id}}
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">微卡昵称</div>
                                        <div class="col-6 text-center">
                                            <i class="fa fa-edit mr-1 cursor-pointer" ng-click="allow_set_user_nickname()"></i>
                                            <span ng-show="allow.edit.user.nickname === false">
                                                {{userData.user.nickname}}
                                            </span>
                                            <span ng-show="allow.edit.user.nickname === true">
                                                <input type="text" class="form-control form-control-sm w-50 py-0" ng-model="userData.user.nickname" style="display:inline-block!important;"
                                                       ng-blur="set_user_nickname()">
                                            </span>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">微卡等级</div>
                                        <div class="col-6 text-center">{{userData.user.grade}}</div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">粉丝</div>
                                        <div class="col-6 text-center">
                                            <span class="badge badge-primary badge-pill">{{userData.user.fansNum}}</span>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">关注</div>
                                        <div class="col-6 text-center">
                                            <span class="badge badge-primary badge-pill">{{userData.user.followNum}}</span>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">卡片</div>
                                        <div class="col-6 text-center">
                                            <span class="badge badge-primary badge-pill">{{userData.user.cardsNum}}</span>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">上次登录时间</div>
                                        <div class="col-6 text-center">
                                            <span class="text-primary">
                                                <i class="fa fa-calendar mr-1"></i>
                                                {{userData.user.lastLoginTime}}
                                            </span>
                                        </div>
                                    </div>
                                </li>

                            </ul>
                        </div>
                    </div>

                    <!-- User Personal Info -->
                    <div class="col-12 col-sm-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3 mb-3" ng-show="user">
                        <div class="card border-radius-0">
                            <div class="card-header">
                                <i class="fa fa-address-book-o mr-1"></i>
                                <div class="d-inline-block">用户个人信息</div>
                            </div>
                            <ul class="list-group list-group-flush">
                                <!-- 1. 用户性别 -->
                                <li class="list-group-item">
                                    <div class="row" onselectstart="return false;">
                                        <div class="col-6 d-flex align-items-center">性别</div>
                                        <div class="col-6 text-center">
                                            <span class="text-dark cursor-pointer" ng-show="allow.edit.user.gender === false" ng-click="allow_set_user_gender()">
                                                {{userData.user.gender === 'male' ? '男性' : '女性'}}
                                            </span>
                                            <span ng-show="allow.edit.user.gender === true">
                                                <select class="form-control form-control-sm form-control-xs w-50 py-0" ng-model="userData.user.gender" style="display:inline-block!important;"
                                                        ng-blur="set_user_gender()">
                                                    <option value="female">女性</option>
                                                    <option value="male">男性</option>
                                                </select>
                                            </span>
                                        </div>
                                    </div>
                                </li>
                                <!-- 2. 用户地址 -->
                                <li class="list-group-item {{allow.edit.user.city?'py-2':''}}">
                                    <div class="row {{allow.edit.user.city?'my-1':''}}">
                                        <div class="{{allow.edit.user.city?'col-4 pr-0':'col-6'}} d-flex align-items-center">城市</div>
                                        <div class="{{allow.edit.user.city?'col-8 px-0':'col-6'}} text-center overflow-hidden">
                                            <span class="cursor-pointer" ng-show="allow.edit.user.city === false" ng-click="allow_set_user_city()">
                                                {{userData.user.city}}
                                            </span>
                                            <span ng-show="allow.edit.user.city === true" style="font-size: 0;">
                                                <span class="d-inline-block" style="width:27%">
                                                    <select id="s_province" name="s_province" class="form-control form-control-sm w-100 p-0 m-0" style="display:inline-block!important;">
                                                    </select>
                                                </span>
                                                <span class="d-inline-block pl-1" style="width:27%">
                                                    <select id="s_city" name="s_city" class="form-control form-control-sm w-100 p-0 m-0" style="display:inline-block!important;"
                                                            ng-focus="user_address.update()" ng-blur="user_address.update()">
                                                    </select>
                                                </span>
                                                <span class="d-inline-block pl-1" style="width:27%">
                                                    <select id="s_county" name="s_county" class="form-control form-control-sm w-100 p-0 m-0" style="display:inline-block!important;"
                                                            ng-focus="user_address.update()" ng-blur="user_address.update()">
                                                    </select>
                                                </span>
                                                <!-- 取消编辑 -->
                                                <span style="font-size: 1rem;position: relative;top: -.25rem;left: .25rem;" ng-show="user_address.legal === false">
                                                    <button class="button button-caution button-circle button-tiny" ng-click="user_address.cancel()">
                                                        <i class="fa fa-times"></i>
                                                    </button>
                                                </span>
                                                <!-- 完成编辑 -->
                                                <span style="font-size: 1rem;position: relative;top: -.25rem;left: .25rem;" ng-show="user_address.legal === true">
                                                    <button class="button button-primary button-circle button-tiny" ng-click="set_user_city()">
                                                        <i class="fa fa-check"></i>
                                                    </button>
                                                </span>
                                                <!-- <input type="text" ng-model="userData.user.city" style="display:none;"> -->
                                            </span>
                                        </div>
                                    </div>
                                </li>
                                <!-- 3. 用户电话号码 -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">电话号码</div>
                                        <div class="col-6 text-center">
                                            <span ng-show="allow.edit.user.phone === false">
                                                <i class="fa fa-phone mr-1"></i>
                                                {{userData.user.phone}}
                                            </span>
                                        </div>
                                    </div>
                                </li>
                                <!-- 4. 用户个性签名 -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">个性签名</div>
                                        <div class="col-6 text-center">
                                            <i class="fa fa-edit mr-1 cursor-pointer" ng-click="allow_set_user_signature()"></i>
                                            <span ng-show="allow.edit.user.signature === false">
                                                {{userData.user.signature}}
                                            </span>
                                            <span ng-show="allow.edit.user.signature === true">
                                                <input type="text" class="form-control form-control-sm w-50 py-0" ng-model="userData.user.signature" style="display:inline-block!important;"
                                                       ng-blur="set_user_signature()">
                                            </span>
                                        </div>
                                    </div>
                                </li>
                                <!-- 5. 用户个人头像 -->
                                <li class="list-group-item py-2">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">头像</div>
                                        <div class="col-6 text-center">
                                            <img class="user-avatar img-thumbnail rounded-circle cursor-pointer"
                                                 ng-src="{{userData.user.avatarUrl}}"
                                                 alt="image not found"
                                                 onclick="$(this).next().trigger('click')">
                                            <!-- 选择用户头像文件 -->
                                            <input type="file" accept="image/png,image/jpg,image/gif" class="display-none" onchange="uploadFile(apis.user.set.avatar,'avatar',$(this))">
                                        </div>
                                    </div>
                                </li>
                                <!-- 6. 用户个人主页背景图片 -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">个人主页背景图片</div>
                                        <div class="col-6 offset-lg-1 col-lg-4 text-center">
                                            <img class="img-fluid border cursor-pointer" src="{{userData.user.styleImgUrl}}" alt="image not found" onclick="$(this).next().trigger('click')">
                                            <!-- 选择用户个人主页背景图片文件 -->
                                            <input type="file" accept="image/png,image/jpg,image/gif" class="display-none" onchange="uploadFile(apis.user.set.styleImage,'styleImg',$(this))">
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>


                    <!-- Global Settings -->
                    <div class="col-12 col-sm-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3 mb-3">
                        <div class="card border-radius-0">
                            <div class="card-header" title="other settings">
                                <i class="fa fa-cog mr-1"></i>
                                <div class="d-inline-block">全局设置</div>
                            </div>
                            <ul class="list-group list-group-flush">
                                <!-- 1. Minimize Navbar -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <i class="fa fa-expand mr-1"></i>
                                            更改导航栏尺寸
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <button class="btn btn-sm btn-primary mr-1 mr-lg-2" ng-click="isNavbarMinimized = false; rememberNavbarSettings();">放大</button>
                                            <button class="btn btn-sm btn-primary" ng-click="isNavbarMinimized = true; rememberNavbarSettings();">缩小</button>
                                        </div>
                                    </div>
                                </li>
                                <!-- 2. Set Navbar Background Color -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <i class="fa fa-adjust mr-1"></i>
                                            更改导航栏背景色
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <button class="btn btn-sm btn-dark mr-1 mr-lg-2" ng-click="isNavbarBackgroundDark = true; rememberNavbarSettings();">深色</button>
                                            <button class="btn btn-sm btn-light" ng-click="isNavbarBackgroundDark = false; rememberNavbarSettings();">浅色</button>
                                        </div>
                                    </div>
                                </li>
                                <!-- 3.1 卡片列表单列显示 -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <i class="fa fa-link mr-1"></i>
                                            <span>卡片列表单列显示</span>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <div ng-show="is_card_columns_single_column_enabled === true">
                                                <button class="btn btn-danger" ng-click="toggle_card_columns_single_column_save('off')">
                                                    <span>关闭</span>
                                                </button>
                                            </div>
                                            <div ng-show="is_card_columns_single_column_enabled === false">
                                                <button class="btn btn-success" ng-click="toggle_card_columns_single_column_save('on')">
                                                    <span>开启</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <!-- 3.2 Always View Card in Another Page -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <i class="fa fa-link mr-1"></i>
                                            <span>始终使用新窗口打开卡片</span>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <div class="ios-button" id="toggle-always-view-card-in-another-page"
                                                 data-button-on="toggleViewCardMethod.on()"
                                                 data-button-off="toggleViewCardMethod.off()"
                                                 data-style="no-support">
                                                <div class="ios-button-circle"></div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <!-- 4. toggle Scroll Control -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <i class="fa fa-caret-square-o-up mr-1"></i>
                                            <span>显示聊天窗口滚动控制器</span>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <i class="fa fa-2x fa-toggle-on toggle-scroll-control" ng-click="toggle_scroll_control();"></i>
                                        </div>
                                    </div>
                                </li>
                                <!-- 5. 按回车发送消息 -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">按回车发送消息</div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <div class="ios-button" id="toggle-press-enter-to-send" data-button-on="enablePressEnterToSend()" data-button-off="disablePressEnterToSend()"
                                                 data-style="no-support">
                                                <div class="ios-button-circle"></div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <!-- 6. 定时开启夜间模式 -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="d-block w-100">
                                                <i class="fa fa-adjust mr-1"></i>
                                                <span>按时开启夜间模式</span>
                                            </div>
                                            <div class="d-block w-100">
                                                <small>开启时间 20:00 至次日 7:00</small>
                                            </div>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <div class="ios-button" id="toggle-night-mode" data-button-on="nightMode.enable()" data-button-off="nightMode.disable()"
                                                 data-style="no-support">
                                                <div class="ios-button-circle"></div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <!-- 7. 立即开启夜间模式 -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="d-block w-100">
                                                <i class="fa fa-adjust mr-1"></i>
                                                <span>立即开启夜间模式</span>
                                            </div>
                                            <div class="d-block w-100">
                                                <small>夜间模式的应用与此开关保持同步</small>
                                            </div>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <div class="ios-button" id="toggle-night-mode-now" data-button-on="applyDarkMode()" data-button-off="cancelDarkMode()"
                                                 data-style="no-support">
                                                <div class="ios-button-circle"></div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <!-- 8. 开发者模式 Debug Mode -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <i class="fa fa-code mr-1"></i>
                                            <span>启用开发者模式</span>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <div class="ios-button" id="toggle-debug-mode" data-button-on="debugMode.enable()" data-button-off="debugMode.disable()"
                                                 data-style="no-support">
                                                <div class="ios-button-circle"></div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Developer Options -->
                    <div class="col-12 col-sm-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3 mb-3" ng-show="debugMode.isEnabled">
                        <div class="card border-radius-0">
                            <div class="card-header">
                                <i class="fa fa-bug mr-1"></i>
                                <div class="d-inline-block">开发者选项</div>
                            </div>
                            <!-- 1. browser info -->
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fa fa-internet-explorer mr-1"></i>
                                    <span>当前浏览器</span>
                                </h5>
                                <p class="card-text">
                                    {{userAgent}}
                                </p>
                            </div>

                            <ul class="list-group list-group-flush">
                                <!-- 2. platform info -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <i class="fa fa-desktop mr-1"></i>
                                            当前 OS
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <div ng-bind="platform"></div>
                                        </div>
                                    </div>
                                </li>
                                <!-- 3. Allow Error Prompt -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <i class="fa fa-exclamation-triangle mr-1"></i>
                                            <span>允许错误警告</span>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <div class="ios-button" id="toggle-allow-error-prompt"
                                                 data-button-on="debugMode.allowErrorPrompt()"
                                                 data-button-off="debugMode.muteErrorPrompt()"
                                                 data-style="no-support">
                                                <div class="ios-button-circle"></div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <!-- 4. Max Loading Delay Time -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <span>"加载中" 时间最大限度(毫秒)</span>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <input type="number" class="form-control form-control-sm border-radius-0" ng-model="max.loading.delay.time" data-default-value="10000">
                                        </div>
                                    </div>
                                </li>
                                <!-- 5. Max Get Messages Limit -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <span>一次加载消息数量最大限度</span>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <input type="number" class="form-control form-control-sm border-radius-0" ng-model="max.get.messages.limit" data-default-value="15">
                                        </div>
                                    </div>
                                </li>
                                <!-- 6. Max Get Cards Limit -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <span>一次加载卡片数量最大限度</span>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <input type="number" class="form-control form-control-sm border-radius-0" ng-model="max.get.cards.limit" data-default-value="10">
                                        </div>
                                    </div>
                                </li>
                                <!-- 7. Max Get Card-Comments Limit -->
                                <li class="list-group-item">
                                    <div class="row">
                                        <div class="col-6 d-flex align-items-center">
                                            <span>一次加载卡片评论数量最大限度</span>
                                        </div>
                                        <div class="col-6 offset-lg-1 col-lg-4 d-flex align-items-center justify-content-center">
                                            <input type="number" class="form-control form-control-sm border-radius-0" ng-model="max.get.card.comments.limit" data-default-value="10">
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>


                </div>
            </div>
            <!-- end of settings(个人中心) -->





            <!-- Room Info Modal -->
            <div class="modal" id="room-info-modal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content border-radius-0">
                        <div class="modal-header">
                            <!-- room info -->
                            <div class="row w-100 m-0">
                                <div class="col-3 p-1 text-center break-all">
                                    <img src="{{current_room.roomImgUrl}}" alt="image not found" class="user-avatar">
                                </div>
                                <div class="col-5 p-0">
                                    <div class="overflow-hidden">
                                        <!-- 我是群主，可以修改群名称 -->
                                        <span ng-if="current_room_my_role === 'owner'">
                                            <!-- 只读状态 -->
                                            <span class="cursor-pointer" ng-show="allow.set.room.name === false" ng-click="allow_set_room_name()">
                                                <span>{{current_room.roomName}}</span>
                                                <i class="fa fa-edit mr-1"></i>
                                            </span>
                                            <!-- 编辑状态 -->
                                            <span ng-show="allow.set.room.name === true">
                                                <input type="text" class="form-control form-control-sm w-75 p-0" ng-model="current_room.roomName" style="display:inline-block!important;"
                                                       ng-blur="set_room_name()">
                                            </span>
                                        </span>
                                        <!-- 我不是群主，群名称是只读的 -->
                                        <span ng-if="current_room_my_role !== 'owner'">
                                            {{current_room.roomName}}
                                        </span>
                                    </div>
                                    <div class="overflow-hidden">
                                        <small class="text-muted">房间 ID: {{current_room.id}}</small>
                                    </div>
                                </div>
                                <div class="col-4 p-0">
                                    <div class="text-muted">成员数量 {{current_room.membersNum}}</div>
                                    <div>
                                        <small class="text-muted">创建时间: {{current_room.roomCreateTime}}</small>
                                    </div>
                                </div>
                            </div>
                            <!-- close button -->
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body p-0">
                            <div class="row m-0">
                                <div class="col-12 py-2 py-lg-3" ng-if="current_room.show_members_info_col">
                                    <div class="w-100">
                                        <button class="btn btn-outline-primary border-radius-0" onclick="$(this).next().show().parent().next().show();">
                                            <div>表格设置</div>
                                        </button>
                                        <button class="btn btn-outline-primary border-radius-0 ml-2" onclick="$(this).hide().parent().next().hide();" 
                                                style="display: none;">
                                            <div>隐藏表格设置</div>
                                        </button>
                                    </div>
                                    <ul class="list-group mt-2" style="display: none;">
                                        <li class="list-group-item" ng-click="current_room.show_members_info_col[0] = !current_room.show_members_info_col[0]">
                                            <div class="d-inline-block mr-2">
                                                <i class="fa fa-lg fa-check-circle-o" ng-if="current_room.show_members_info_col[0] == true"></i>
                                                <i class="fa fa-lg fa-circle-o" ng-if="current_room.show_members_info_col[0] == false"></i>
                                            </div>
                                            <div class="d-inline-block">显示头像</div>
                                        </li>
                                        <li class="list-group-item" ng-click="current_room.show_members_info_col[1] = !current_room.show_members_info_col[1]">
                                            <div class="d-inline-block mr-2">
                                                <i class="fa fa-lg fa-check-circle-o" ng-if="current_room.show_members_info_col[1] == true"></i>
                                                <i class="fa fa-lg fa-circle-o" ng-if="current_room.show_members_info_col[1] == false"></i>
                                            </div>
                                            <div class="d-inline-block">显示用户名</div>
                                        </li>
                                        <li class="list-group-item" ng-click="current_room.show_members_info_col[2] = !current_room.show_members_info_col[2]">
                                            <div class="d-inline-block mr-2">
                                                <i class="fa fa-lg fa-check-circle-o" ng-if="current_room.show_members_info_col[2] == true"></i>
                                                <i class="fa fa-lg fa-circle-o" ng-if="current_room.show_members_info_col[2] == false"></i>
                                            </div>
                                            <div class="d-inline-block">显示角色</div>
                                        </li>
                                        <li class="list-group-item" ng-click="current_room.show_members_info_col[3] = !current_room.show_members_info_col[3]">
                                            <div class="d-inline-block mr-2">
                                                <i class="fa fa-lg fa-check-circle-o" ng-if="current_room.show_members_info_col[3] == true"></i>
                                                <i class="fa fa-lg fa-circle-o" ng-if="current_room.show_members_info_col[3] == false"></i>
                                            </div>
                                            <div class="d-inline-block">显示群名片</div>
                                        </li>
                                        <li class="list-group-item" ng-click="current_room.show_members_info_col[4] = !current_room.show_members_info_col[4]">
                                            <div class="d-inline-block mr-2">
                                                <i class="fa fa-lg fa-check-circle-o" ng-if="current_room.show_members_info_col[4] == true"></i>
                                                <i class="fa fa-lg fa-circle-o" ng-if="current_room.show_members_info_col[4] == false"></i>
                                            </div>
                                            <div class="d-inline-block">显示操作</div>
                                        </li>
                                    </ul>
                                </div>
                                <style>
                                    .w-4-rem {
                                        min-width: 4rem;
                                        width: 4rem;
                                        max-width: 4rem;
                                    }

                                    .w-10 {
                                        min-width: 10%;
                                        width: 10%;
                                        max-width:10%;
                                    }

                                    .w-20 {
                                        min-width: 20%;
                                        width: 20%;
                                        max-width:20%;
                                    }
                                </style>
                                <!-- room member list -->
                                <div class="col-12 p-0">
                                    <table class="table table-sm mb-2">
                                        <thead>
                                        <tr class="d-flex flex-row justify-content-start">
                                            <th class="border-0 d-flex align-items-center justify-content-center w-4-rem" ng-show="current_room.show_members_info_col[0]">
                                                头像
                                            </th>
                                            <th class="border-0 d-flex align-items-center w-20" ng-show="current_room.show_members_info_col[1]">
                                                用户名
                                                <div class="d-inline-block ml-1">
                                                    <button class="button button-glow button-circle button-plain button-tiny">
                                                        <i class="fa fa-search"></i>
                                                    </button>
                                                </div>
                                            </th>
                                            <th class="border-0 d-flex align-items-center w-10" ng-show="current_room.show_members_info_col[2]">
                                                角色
                                            </th>
                                            <th class="border-0 d-flex align-items-center w-20" ng-show="current_room.show_members_info_col[3]">
                                                群名片
                                                <div class="d-inline-block ml-1">
                                                    <button class="button button-glow button-circle button-plain button-tiny">
                                                        <i class="fa fa-search"></i>
                                                    </button>
                                                </div>
                                            </th>
                                            <th class="border-0 d-flex align-items-center justify-content-center w-25" ng-show="current_room.show_members_info_col[4]">
                                                操作
                                            </th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr ng-repeat="member in current_room_members track by $index" class="d-flex flex-row justify-content-start"
                                            ng-show="$index >= current_room_members_list_offset * current_room_members_list_limit && (current_room_members_list_offset + 1) * current_room_members_list_limit > $index">
                                            <!-- 1 头像 -->
                                            <th class="border-0 d-flex align-items-center p-0 w-4-rem" ng-show="current_room.show_members_info_col[0]">
                                                <div class="w-100 text-center">
                                                    <img class="user-avatar-sm rounded-circle img-thumbnail cursor-pointer" ng-src="{{member.avatarUrl}}" alt="x" ng-click="startChatWithRoomMember(member.id)">
                                                </div>
                                            </th>
                                            <!-- 2 用户名 -->
                                            <td class="border-0 d-flex align-items-center w-20" ng-show="current_room.show_members_info_col[1]">
                                                <span class="d-flex align-self-center w-100">
                                                    <div class="inline-block overflow-hidden mx-1">
                                                        <span class="{{userData.user.id === member.id ? 'text-danger' : 'text-dark'}}">{{member.nickname}}</span>
                                                        <small class="text-muted">({{member.username}})</small>
                                                    </div>
                                                </span>
                                            </td>
                                            <!-- 3 角色 -->
                                            <td class="border-0 d-flex align-items-center w-10" ng-show="current_room.show_members_info_col[2]">
                                                <span class="d-flex align-self-center w-100">
                                                    <small class="text-primary" ng-if="member.role === 'owner'">群主</small>
                                                    <small class="text-success" ng-if="member.role === 'admin'">管理员</small>
                                                    <small class="text-muted" ng-if="member.role === 'member'">成员</small>
                                                </span>
                                            </td>
                                            <!-- 4 群名片 -->
                                            <td class="border-0 d-flex align-items-center w-20" ng-show="current_room.show_members_info_col[3]">
                                                <div class="d-flex align-self-center w-100">
                                                    <div class="inline-block overflow-hidden">
                                                        <span ng-switch="userData.user.id === member.id">
                                                            <!-- 群成员是自己 -->
                                                            <span ng-switch-when="true">
                                                                <!-- 只读状态 -->
                                                                <span ng-show="allow.set.room.member.remark === false">
                                                                    <span class="cursor-pointer" ng-click="allow_set_room_member_remark()">
                                                                        <i class="fa fa-edit mr-1"></i>
                                                                        {{member.roomRemark}}
                                                                    </span>
                                                                </span>
                                                                <!-- 编辑状态 -->
                                                                <span ng-show="allow.set.room.member.remark === true">
                                                                    <input type="text" class="form-control form-control-sm w-75 p-0" ng-model="member.roomRemark" style="display:inline-block!important;"
                                                                            ng-blur="set_room_member_remark()">
                                                                </span>
                                                            </span>
                                                            <!-- 群成员是别人 -->
                                                            <span ng-switch-when="false">
                                                                <span class="text-dark">{{member.roomRemark}}</span>
                                                            </span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </td>
                                            <!-- 5 操作 -->
                                            <td class="border-0 d-flex align-items-center justify-content-center w-25" ng-show="current_room.show_members_info_col[4]">
                                                <!-- room member options start -->
                                                <!-- set room member -->
                                                <span ng-switch="set_room_admin_is_ok(current_room_my_role,member.role)">
                                                    <!-- true -->
                                                    <span ng-switch-when="true" class="mx-1" data-toggle="tooltip" data-placement="bottom" title="设为管理员">
                                                        <button class="button button-glow button-circle button-action button-tiny" ng-click="set_room_admin(current_room.id, member.id)">
                                                            <i class="fa fa-user-secret"></i>
                                                        </button>
                                                    </span>
                                                    <!-- false -->
                                                    <span ng-switch-when="false">
                                                        <span ng-switch="disable_room_admin_is_ok(current_room_my_role,member.role)">
                                                            <!-- true -->
                                                            <span ng-switch-when="true" class="mx-1" data-toggle="tooltip" data-placement="bottom" title="取消管理员">
                                                                <button class="button button-glow button-circle button-caution button-tiny" ng-click="disable_room_admin(current_room.id, member.id)">
                                                                    <i class="fa fa-user-secret"></i>
                                                                </button>
                                                            </span>
                                                            <!-- false -->
                                                            <span ng-switch-when="false" class="mx-1">
                                                                <button class="button button-circle button-action button-tiny" disabled>
                                                                    <i class="fa fa-user-secret"></i>
                                                                </button>
                                                            </span>
                                                        </span>
                                                    </span>
                                                </span>
                                                <!-- add friend -->
                                                <span ng-switch="add_friend_is_ok(userData.user.id, member.id)">
                                                    <!-- true -->
                                                    <span ng-switch-when="true" class="mx-1" data-toggle="tooltip" data-placement="bottom" title="添加好友">
                                                        <button class="button button-glow button-circle button-highlight button-tiny" ng-click="add_room_member_friend(member.id)"
                                                                data-toggle="popover" title="{{getAddFriendTitle(member)}}" data-content="{{getAddFriendContent(member)}}">
                                                            <i class="fa fa-plus"></i>
                                                        </button>
                                                    </span>
                                                    <!-- false -->
                                                    <span ng-switch-when="false" class="mx-1">
                                                        <button class="button button-circle button-highlight button-tiny" disabled>
                                                            <i class="fa fa-plus"></i>
                                                        </button>
                                                    </span>
                                                    <!-- default -->
                                                    <span ng-switch-default class="mx-1">
                                                        <button class="button button-circle button-highlight button-tiny" disabled>
                                                            <i class="fa fa-plus"></i>
                                                        </button>
                                                    </span>
                                                </span>
                                                <!-- remove room member -->
                                                <span ng-switch="remove_room_member_is_ok(current_room_my_role,member.role)">
                                                    <!-- true -->
                                                    <span ng-switch-when="true" class="mx-1" data-toggle="tooltip" data-placement="bottom" title="移出">
                                                        <button class="button button-glow button-circle button-caution button-tiny" ng-click="remove_room_member(current_room.id, member.id)">
                                                            <i class="fa fa-user-times"></i>
                                                        </button>
                                                    </span>
                                                    <!-- false -->
                                                    <span ng-switch-when="false" class="mx-1">
                                                        <button class="button button-circle button-caution button-tiny" disabled>
                                                            <i class="fa fa-user-times"></i>
                                                        </button>
                                                    </span>
                                                </span>
                                                <!-- room member options end -->
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- pagination -->
                                <div class="col-12 p-0">
                                    <nav>
                                        <ul class="pagination pagination-sm justify-content-center mb-2">
                                            <li class="page-item disabled" ng-if="current_room_members.length > 0" 
                                                onclick="$(this).siblings().removeClass('disabled');$(this).addClass('disabled');">
                                                <a class="page-link py-0" href="#" ng-click="$parent.current_room_members_list_offset = 0">1</a>
                                            </li>
                                            <li class="page-item" ng-if="current_room_members.length > 1 * current_room_members_list_limit" 
                                                onclick="$(this).siblings().removeClass('disabled');$(this).addClass('disabled');">
                                                <a class="page-link py-0" href="#" ng-click="$parent.current_room_members_list_offset = 1">2</a>
                                            </li>
                                            <li class="page-item" ng-if="current_room_members.length > 2 * current_room_members_list_limit" 
                                                onclick="$(this).siblings().removeClass('disabled');$(this).addClass('disabled');">
                                                <a class="page-link py-0" href="#" ng-click="$parent.current_room_members_list_offset = 2">3</a>
                                            </li>
                                            <li class="page-item" ng-if="current_room_members.length > 3 * current_room_members_list_limit" 
                                                onclick="$(this).siblings().removeClass('disabled');(this).addClass('disabled');">
                                                <a class="page-link py-0" href="#" ng-click="$parent.current_room_members_list_offset = 3">4</a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary border-radius-0 px-4" data-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary border-radius-0" ng-click="">分享聊天室</button>
                            <button type="button" class="btn btn-danger border-radius-0" ng-click="remove_room(current_room.id)" ng-show="['owner'].includes(current_room_my_role)">
                                解散聊天室
                            </button>
                            <button type="button" class="btn btn-danger border-radius-0" ng-click="quit_room(current_room.id)" ng-show="!['owner'].includes(current_room_my_role)">
                                退出聊天室
                            </button>
                        </div>
                    </div>
                </div>
            </div>







            <!-- Friend Info Modal -->
            <div class="modal" id="friend-info-modal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content border-radius-0">
                        <div class="modal-header">
                            <!-- friend info -->
                            <div class="row w-100 m-0">
                                <div class="col-3 p-1 text-center break-all">
                                    <img ng-src="{{current_friend.avatarUrl}}" alt="x" class="user-avatar rounded-circle">
                                </div>
                                <div class="col-5 p-0">
                                    <div class="overflow-hidden">
                                        <span>{{current_friend.nickname}}</span>
                                        <span>({{current_friend.username}})</span>
                                    </div>
                                    <div class="text-muted overflow-hidden">
                                        <small class="d-inline-block" onselectstart="return false;">备注名:</small>
                                        <!-- 只读状态 -->
                                        <small class="cursor-pointer" ng-show="allow.set.friend.remark === false" ng-click="allow_set_friend_remark()">
                                            <span>{{current_friend.remark}}</span>
                                            <i class="fa fa-edit mr-1"></i>
                                        </small>
                                        <!-- 编辑状态 -->
                                        <span ng-show="allow.set.friend.remark === true">
                                            <input type="text" class="form-control form-control-sm w-50 w-lg-75 p-0" ng-model="current_friend.remark" style="display:inline-block!important;"
                                                   ng-blur="set_friend_remark()">
                                        </span>
                                    </div>
                                </div>
                                <div class="col-4 p-0">
                                    <div>
                                        <small class="text-muted">用户 ID: {{current_friend.id}}</small>
                                    </div>
                                    <div>
                                        <small class="text-muted">性别: {{current_friend.gender=='male'?'男':'女'}}</small>
                                    </div>
                                </div>
                            </div>
                            <!-- close button -->
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- friend info -->
                            <div class="row">
                                <div class="col-12 mb-2 mx-md-auto col-md-6 mb-md-0">
                                    <div class="row">
                                        <div class="col-6 py-1 d-flex justify-content-center align-items-center">
                                            <span class="cursor-pointer" ng-click="allow_move_friend_to_group()">
                                                设置分组
                                            </span>
                                        </div>
                                        <div class="col-6 d-flex justify-content-center align-items-center">
                                            <div class="cursor-pointer" ng-if="allow.set.friend.group === false" ng-click="allow_move_friend_to_group()">
                                                <span ng-bind="get_group_of_friend(current_friend).groupName"></span>
                                                <span>
                                                    <i class="fa fa-edit ml-1"></i>
                                                </span>
                                            </div>
                                            <div class="w-100 d-flex justify-content-center align-items-center" ng-if="allow.set.friend.group === true">
                                                <select class="form-control form-control-sm group-select" ng-blur="move_current_friend_to_group()">
                                                    <option ng-repeat="group in userData.groups track by $index" value="{{group.id}}" ng-bind="group.groupName" ng-if="group === get_group_of_friend(current_friend)"
                                                            selected disabled></option>
                                                    <option ng-repeat="group in userData.groups track by $index" value="{{group.id}}" ng-bind="group.groupName" ng-if="group !== get_group_of_friend(current_friend)"></option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary border-radius-0 px-4" data-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary border-radius-0" ng-click="">分享联系人</button>
                            <button type="button" class="btn btn-danger border-radius-0" ng-click="remove_friend(current_friend.id)">
                                删除联系人
                            </button>
                        </div>
                    </div>
                </div>
            </div>







            <!-- Set Friend Remark Modal -->
            <div class="modal set-friend-remark-modal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content border-radius-0">
                        <div class="modal-header">
                            <!-- friend info -->
                            <div class="row w-100 m-0">
                                <div class="col-3 p-1 text-center break-all">
                                    <img ng-src="{{this_friend.avatarUrl}}" alt="x" class="user-avatar rounded-circle">
                                </div>
                                <div class="col-6 p-0 d-flex align-items-center">
                                    <div class="overflow-hidden">
                                        <span>{{this_friend.nickname}}</span>
                                        <span>({{this_friend.username}})</span>
                                    </div>
                                </div>
                            </div>
                            <!-- close button -->
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- friend remark editing field -->
                            <div class="row">
                                <div class="col-12 mb-2 mx-md-auto col-md-6 mb-md-0">
                                    <div class="row">
                                        <div class="col-12 d-flex justify-content-center align-items-center">
                                            <div class="w-100 d-flex justify-content-center align-items-center">
                                                <div class="d-inline-block w-50 text-center" onselectstart="return false;">
                                                    备注名:
                                                </div>
                                                <!-- 只读状态 -->
                                                <div class="d-inline-block w-50 cursor-pointer" ng-show="allow.set.friend.remark === false" 
                                                     ng-click="allow_set_friend_remark()">
                                                    <span ng-bind="this_friend.remark"></span>
                                                    <i class="fa fa-edit mr-1"></i>
                                                </div>
                                                <!-- 编辑状态 -->
                                                <div class="d-inline-block w-50" ng-show="allow.set.friend.remark === true">
                                                    <input type="text" class="form-control form-control-sm p-0" 
                                                           ng-model="this_friend.remark" 
                                                           style="display:inline-block!important;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary border-radius-0 px-4 set-friend-remark-submit" data-dismiss="modal">
                                确定
                            </button>
                            <button type="button" class="btn btn-secondary border-radius-0 px-4" data-dismiss="modal">
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            </div>






            <!-- Friend Group Select Modal -->
            <div class="modal move-friend-to-group">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content border-radius-0">
                        <div class="modal-header">
                            <!-- friend info -->
                            <div class="row w-100 m-0">
                                <div class="col-3 p-1 text-center break-all">
                                    <img ng-src="{{this_friend.avatarUrl}}" alt="x" class="user-avatar rounded-circle">
                                </div>
                                <div class="col-6 p-0 d-flex align-items-center">
                                    <div class="overflow-hidden">
                                        <span>{{this_friend.nickname}}</span>
                                        <span>({{this_friend.username}})</span>
                                    </div>
                                </div>
                            </div>
                            <!-- close button -->
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- friend group select -->
                            <div class="row">
                                <div class="col-12 mb-2 mx-md-auto col-md-6 mb-md-0">
                                    <div class="row">
                                        <div class="col-12 col-md-6 py-1 d-flex justify-content-center align-items-center">
                                            <div class="w-100 d-flex justify-content-center align-items-center">
                                                <div class="d-inline-block w-50 text-center" onselectstart="return false;">
                                                    当前分组
                                                </div>
                                                <div class="d-inline-block w-50">
                                                    <span ng-if="this_friend" ng-bind="get_group_of_friend(this_friend).groupName"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-6 d-flex justify-content-center align-items-center">
                                            <div class="w-100 d-flex justify-content-center align-items-center">
                                                <div class="d-inline-block w-50 text-center" onselectstart="return false;">
                                                    选择新分组
                                                </div>
                                                <div class="d-inline-block w-50">
                                                    <select class="form-control form-control-sm group-select">
                                                        <option ng-repeat="group in userData.groups track by $index" value="{{group.id}}" ng-bind="group.groupName"
                                                                ng-if="group === get_group_of_friend(current_friend)"
                                                                selected disabled></option>
                                                        <option ng-repeat="group in userData.groups track by $index" value="{{group.id}}" ng-bind="group.groupName"
                                                                ng-if="group !== get_group_of_friend(current_friend)"></option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary border-radius-0 px-4 move-friend-to-group" data-dismiss="modal">
                                确定
                            </button>
                            <button type="button" class="btn btn-secondary border-radius-0 px-4" data-dismiss="modal">
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            </div>









            <div class="footer row" ng-show="pageLocation === 'marketplace'">
                <ul class="col-12 col-lg-4 py-2 py-lg-5 px-1">
                    <li>友情链接</li>
                    <li>
                        <a target="_blank" href="https://top.wsmpage.cn:8323">
                            天津工业大学 wego 社团迎新
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="https://top.wsmpage.cn:8888">
                            天津工业大学 wego 社团报名
                        </a>
                    </li>
                </ul>
                <ul class="col-12 col-lg-4 py-2 py-lg-5 px-1">
                    <li>备案信息</li>
                    <li>域名 www.impte.com</li>
                    <li>
                        <a target="_blank" href="http://www.beian.gov.cn">
                            <small>
                                <span class="d-inline-block upper">
                                    <img src="img/icon-police.png" alt="">
                                </span>
                                津 ICP 备 17004538 号 -2
                            </small>
                        </a>
                    </li>
                </ul>
                <ul class="col-12 col-lg-4 py-2 py-lg-5 px-1">
                    <li>卡片显示模式</li>
                    <li>
                        <div class="a cursor-pointer" ng-click="cardsViewMode = 'classic'">
                            <i class="fa fa-check-circle-o" ng-show="['classic'].includes(cardsViewMode)"></i>
                            <i class="fa fa-circle-o" ng-show="!['classic'].includes(cardsViewMode)"></i>
                            <span>经典</span>
                        </div>
                    </li>
                    <li>
                        <div class="a cursor-pointer" ng-click="cardsViewMode = 'list'">
                            <i class="fa fa-check-circle-o" ng-show="['list'].includes(cardsViewMode)"></i>
                            <i class="fa fa-circle-o" ng-show="!['list'].includes(cardsViewMode)"></i>
                            <span>列表</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <!-- controller -->
    </div>




















    <script src="../js/vendor/ios-button.js"></script>
    <script src="../js/press_enter_to_send.js"></script>
    <script src="../js/scroll_control.js"></script>

    <script>
        function mockLogin() {
            abortLoading();
            $("[ng-show='user']").removeClass("ng-hide");
            $("[ng-show='!user']").addClass("ng-hide");
        }
    </script>

    <script src="../js/vendor/editor.js"></script>
    <script>
        function getImageSrc(picNum) {
            return $(".card-image-preview").eq(picNum).attr("src");
        }

        function activateImageLine (event, picNum) {
            function addTools (event, picNum) {
                $(event.target)
                    .append("<i class='fa fa-search mx-1'></i>")
                    .append("<i class='fa fa-plus mx-1'></i>")
                    .append("<i class='fa fa-minus mx-1'></i>");
                $(event.target).find(".fa.fa-minus").off("click").on("click", function() {
                    $(this).parent().find(".card-image").remove();
                });
                $(event.target).find(".fa.fa-plus").off("click").on("click", function() {
                    $(this).parent().find(".card-image").remove();
                    $(this).parent().append("<div class='card-image card-image-wrapper'>" +
                        "   <img class='img-thumbnail' src='" + getImageSrc(picNum) + "' " +
                        "       onclick=\"$(this).attr('src', getImageSrc(" + picNum + "));\">" +
                        "</div>");
                });
                $(event.target).find(".fa.fa-search").off("click").on("click", function() {
                    inspect_image(getImageSrc(picNum));
                });
            }

            // 将当前图片行设置为不可编辑状态, 从下一行按退格回到这一行, 这一行才能恢复为可编辑状态
            event.target.contentEditable = false;
            $(event.target)
                .removeClass("line")
                .addClass("alert-success mb-0 cursor-pointer hover-expand-y hover-shadow half-hidden hover-show")
                .attr({
                    "title": "图片 " + picNum,
                    "data-toggle": "tooltip"
                }).on("click", function() {
                    if ($(this).find(".fa").length) {
                    } else {
                        addTools(event, picNum);
                    }
                });
            addTools(event, picNum);
        }


        function activateIconLine (event, username) {
            // 将当前图标行设置为不可编辑状态, 从下一行按退格回到这一行, 这一行才能恢复为可编辑状态
            event.target.contentEditable = false;
            $(event.target)
                .removeClass("line")
                .addClass("alert-success mb-0 cursor-pointer hover-expand-y hover-shadow half-hidden hover-show")
                .attr({
                    "title": "用户 " + username,
                    "data-toggle": "tooltip"
                }).off("click").on("click", function() {
                    bsAlert("当前卡片未被上传, 无法查看正在编辑的卡片中的用户");
                });
        }


        // "1, 2, 3, 4, 5, 6"
        function myRange(begin, end) {
            return _.range(begin, end).join(", ");
        };


        // ["1", "2", "3", "4", "5", "6"]
        function myRangeStr(begin, end) {
            return _.range(begin, end).map(function (e) {
                return "" + e;
            });
        };


        function insertImageLine(event, tools) {
            var isInsertPic = confirm("插入图片?");
            if (isInsertPic) {
                var msgs = [
                    "您要插入第几张图片?",
                    "请输入图片的编号, 可选的值有: " + myRange(0, 6),
                    "请确保您输入的编号小于卡片附件图片的长度, 否则卡片渲染器将找不到对应的图片"
                ];
                var picNum = prompt(msgs.join("\n"));
                if (myRangeStr(0, 6).includes(picNum)) {
                    picNum = Number.parseInt(picNum);
                    if (_.range(0, 6).includes(picNum)) {
                        event.preventDefault();
                        event.target.innerHTML = "![图片-" + picNum + "](图片-" + picNum + ")";
                        activateImageLine(event, picNum);
                        tools.insertNewLine();
                    }
                }
            }
        }


        function insertIconLine(event, tools) {
            var isInsertIcon = confirm("插入用户头像?");
            if (isInsertIcon) {
                var msgs = [
                    "您要插入哪位用户的头像?",
                    "请输入该用户的用户名",
                    "请确保您输入的用户名是有效的, 否则卡片渲染器将找不到对应的用户"
                ];
                var username = prompt(msgs.join("\n"));
                if (username) {
                    username = username.trim();
                    if (username.length) {
                        event.preventDefault();
                        event.target.innerHTML = "@iconify(user,name," + username + ")";
                        activateIconLine(event, username);
                        tools.insertNewLine();
                    }
                }
            }
        }


        var isComputerKeyboard = false;


        // 监听键盘按下的监听器
        function keyPressListener(event, storage, tools, $scope) {
            // 16 是 Shift, 49 是 '1', Shift + '1' 是 '!'
            // 如果在一个空行的行首输入了 !, 就询问是否插入图片
            if (storage.prevKeyCode === 16 && event.keyCode === 49 && tools.getCursorPosition() === 0 && !event.target.innerHTML) {
                insertImageLine(event, tools);
            } else if (storage.prevKeyCode === 16 && event.keyCode === 50 && tools.getCursorPosition() === 0 && !event.target.innerHTML) {
                insertIconLine(event, tools);
            }
            // 记录上次按下的键
            storage.prevKeyCode = event.keyCode;
            // 判断是否按下了 shift 键
            if (event.keyCode === 16) {
                isComputerKeyboard = true;
            }
        }


        // 监听文本行改变的监听器
        function onTextChange(newVal, storage, event, tools) {
            if (!isComputerKeyboard) {
                // 不是使用电脑键盘 shift 键输入的
                if (newVal === "!") {
                    insertImageLine(event, tools);
                } else if (newVal === "@") {
                    insertIconLine(event, tools);
                }
            }
        }


        v2_7.init(".form-control-v2-7#card-to-create-text-v2-7", function($scope, text) {
            $scope.card_to_create.text = text;
            $scope.$apply();
        }, keyPressListener, onTextChange);

        v2_7.reload = function () {
            var $scope = v2_7.getScope();
            var lines = $scope.card_to_create.text.split("\n");
            if (lines && lines.length) {
                v2_7.empty().text(lines[0]);
                for (var i = 1; i < lines.length; ++i) {
                    v2_7.insertNewLine().text(lines[i]);
                }
            }
        }

        v2_7.initHelp = function () {
            var id = "help-prompt-" + new Date().getTime();
            var totalTime = 10;
            v2_7.data.helpTitle = "v2.7 卡片编辑器 功能介绍";
            v2_7.data.helpContent = "<div>" +
                "   <p>在一个空行中, 输入 \"!\" 可以插入图片, " +
                "       <span class='d-block'>也就是将卡片附件中的图片插入到卡片正文中</span>" +
                "   </p>" +
                "   <p>在一个空行中, 输入 \"@\" 可以插入用户头像</p>" +
                "   <p>由于技术问题, 目前不支持多行选择, 仅支持单行选择</p>" +
                "   <p>本介绍将在 <span id='" + id + "'>" + totalTime + "</span> 秒后自动关闭</p>" +
                "</div>";
            v2_7.data.helpClass = "alert-success";
            var timeLeft = totalTime * 1000;
            var timer = setInterval(() => {
                timeLeft -= 1000;
                var timeField = $("#" + id);
                if (timeLeft <= 0) {
                    var prompt = timeField.closest(".alert");
                    if (prompt && prompt.length) {
                        removeAlert(prompt);
                    }
                    window.clearInterval(timer);
                } else {
                    timeField.text(timeLeft / 1000);
                }
            }, 1000);
        }
    </script>
    <!-- essentials -->
    <script src="../js/_homepage_web_socket.js"></script>
    <!-- update -->
    <script src="../js/update_friend_group.js"></script>
    <script src="../js/update_request.js"></script>
    <script src="../js/update_portal.js"></script>
    <script src="../js/update_message.js"></script>
    <!-- load new -->
    <script src="../js/load_new_friend_group.js"></script>
    <script src="../js/load_new_portal.js"></script>
    <script src="../js/append_message_linkable.js"></script>
    <script src="../js/load_new_message.js"></script>
    <script src="../js/load_new_notification.js"></script>
    <script src="../js/load_new_request.js"></script>
    <script src="../js/load_new_room.js"></script>
    <!-- remove -->
    <script src="../js/remove_room.js"></script>
    <script src="../js/remove_portal.js"></script>
    <script src="../js/remove_friend.js"></script>
    <!-- send -->
    <script src="../js/add_friend_request_send.js"></script>
    <script src="../js/add_friend_request_agree.js"></script>
    <script src="../js/add_friend_request_refuse.js"></script>
    <script src="../js/join_room_request_send.js"></script>
    <script src="../js/join_room_request_agree.js"></script>
    <!-- user -->
    <script src="../js/set_user_avatar.js"></script>
    <script src="../js/set_user_city.js"></script>
    <!-- city select -->
    <script>
        _init_area();
    </script>



    <script src="../js/controllers/cardPreviewCtrl.js"></script>
    <script src="../js/controllers/sharedCardPreviewCtrl.js"></script>
    <script src="../js/controllers/cardViewCtrl.js"></script>
    <script src="../js/controllers/cardCommentXSCtrl.js"></script>
    <script src="../js/controllers/cardCommentSMCtrl.js"></script>
    <script src="../js/controllers/cardCommentMDCtrl.js"></script>
    <script src="../js/controllers/cardInfoCtrl.js"></script>
    <script src="../js/controllers/shareCardCtrl.js"></script>
    <script src="../js/controllers/shareCardToFriendsCtrl.js"></script>
    <script src="../js/controllers/chatWindowCtrl.js"></script>
    <!-- <script src="../js/_login.js"></script> -->
    <script src="../js/_logout.js"></script>

    <script>
        function login(target, parameters) {
            let address = "../login.html?from=" + window.location.pathname + "&target=" + target;
            if (parameters) {
                for (let name in parameters) {
                    address += "&" + name + "=" + parameters[name];
                }
            }
            window.location.href = address;
        }
    </script>

    <script>
        var darkModeTimer = null;

        var darkModeApplicableClasses = {};
        darkModeApplicableClasses.borderedClasses = [
            ".card",
            ".card-header",
            ".card-footer",
            ".modal-header",
            ".modal-body",
            ".modal-footer",
            ".alert",
            ".list-group-item",
            ".form-control",
            ".navbar-inner-wrapper",// SHOULD apply border-bottom
            ".navbar-wrapper",// SHOULD NOT apply border-bottom
            ".navbar",// CANNOT and SHOULD NOT apply border-bottom
            ".nav-item",// SHOULD have border
            ".nav-link",// SHOULD NOT have border
            ".btn",
            ".btn-primary",
            ".btn-secondary",
            ".btn-success",
            ".btn-danger",
            ".btn-warning",
            ".btn-info",
            ".btn-outline-primary",
            ".btn-outline-secondary",
            ".btn-outline-success",
            ".btn-outline-danger",
            ".btn-outline-warning",
            ".btn-outline-info",
            ".footer",
            ".footer ul",// footer of the main page
            ".chat-window",
            ".current-portal",
            ".chat-window .editor",
            ".chat-window .scroll-control",
            ".badge",
            ".message-create-time.d-inline-block",
            ".button",
            ".popover",
            ".popover-header",
            ".popover-body",
            ".tooltip-inner",
            ".img-thumbnail",
            ".dropdown-menu"
        ].join(",");
        darkModeApplicableClasses.inlineClasses = [
            "body",
            ".modal",
            ".modal-content",
            ".alert-primary",
            ".alert-secondary",
            ".alert-danger",
            ".alert-warning",
            ".alert-dark",
            ".bg-primary",
            ".bg-warning",
            ".bg-danger",
            ".bg-secondary",
            ".bg-dark",
            ".bg-white",
            ".text-muted",
            ".text-primary",
            ".text-danger",
            ".text-dark",
            ".text-white",
            ".footer a",// links in footer of the main page
            ".tooltip",
            ".dropdown-item",
            ".fa",
            "pre.line"
        ].join(",");

        // dme: dark mode enabled
        // dme-b: dark mode element bordered
        // dme-i: dark mode element inline
        // dme-d: dark mode element dynamic
        function applyDarkMode() {
            $("#toggle-night-mode-now").attr("data-value", true);
            ios_button_init(".settings");
            $(darkModeApplicableClasses.borderedClasses).addClass("dme dme-b");
            $(darkModeApplicableClasses.inlineClasses).addClass("dme dme-i");
            darkModeTimer = setInterval(function () {
                $(darkModeApplicableClasses.borderedClasses).addClass("dme dme-b dme-d");
                $(darkModeApplicableClasses.inlineClasses).addClass("dme dme-i dme-d");
            }, 1000);
        }

        function cancelDarkMode() {
            $("#toggle-night-mode-now").attr("data-value", false);
            ios_button_init(".settings");
            $(darkModeApplicableClasses.borderedClasses).removeClass("dme dme-b dme-d");
            $(darkModeApplicableClasses.inlineClasses).removeClass("dme dme-i dme-d");
            clearInterval(darkModeTimer);
            darkModeTimer = null;
        }

        function getMinutesBefore(hour, minutes) {
            if (!minutes) {
                hour = hour - 1;
                minutes = 60;
            }
            const now = new Date();
            return ((hour + 24 - now.getHours()) % 24) * 3600 + (minutes - now.getMinutes()) * 60;
        }

        (function (window) {
            var isNightModeEnabled = false;

            if (window.nightMode) {
                isNightModeEnabled = window.nightMode.isEnabled;
            } else {
                isNightModeEnabled = window.localStorage.getItem("is_night_mode_enabled");
            }

            if (isNightModeEnabled && [true, "true"].includes(isNightModeEnabled)) {
                const now = new Date();
                if (now.getHours() >= 20 || now.getHours() <= 6) {// hours in [0, 6] or [20, 23]
                    window.applyDarkMode && window.applyDarkMode();
                } else if (window.applyDarkMode) {// hours in [7 ... 19]
                    window.setTimeout(function () {
                        window.applyDarkMode();
                    }, 1000 * window.getMinutesBefore(20));
                }
                if (window.cancelDarkMode) {
                    window.setTimeout(function () {
                        window.cancelDarkMode();
                    }, 1000 * window.getMinutesBefore(7));
                }
            }
        })(window);

        // 实时刷新页面
        setInterval(function () {
            // 激活弹窗元素
            $('[data-toggle="tooltip"]').tooltip();
            $('[data-toggle="popover"]').popover({
                container: 'body',
                placement: 'bottom',
                trigger: 'click',
                html: true
            });
            // 重置聊天窗口最低高度
            $(".chat-window").css("min-height", $(window).height());
        }, 1000);
    </script>

    <!-- remove popovers & tootips -->
    <script src="../js/_utils.js"></script>
    <!-- parse table in card -->
    <script src="../js/vendor/wc-table.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.0.0/dist/purify.min.js" type="text/javascript"></script>
    <!-- Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
</body>

</html>